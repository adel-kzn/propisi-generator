<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø–∏—Å—å–º–∞</title>

    <meta name="yandex-verification" content="zoqf7gn5mwyntin5" />

    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106467293', 'ym');

        ym(106467293, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", referrer: document.referrer, url: location.href, accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/106467293" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <style>
        /* --- APPLE / MACOS STYLE SYSTEM --- */
        :root {
            --app-bg: #F2F2F7;
            --sidebar-bg: rgba(255, 255, 255, 0.85);
            --sidebar-border: rgba(0, 0, 0, 0.05);
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
            --accent: #007AFF;
            --accent-hover: #0062cc;
            --danger: #FF3B30;
            --radius-L: 16px;
            --radius-M: 10px;
            --shadow-card: 0 8px 40px rgba(0, 0, 0, 0.12);
            --z-sidebar: 1000;
            --z-overlay: 900;
            --z-menu-btn: 800;
            --z-zoom: 500;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--app-bg);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* --- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ (SIDEBAR) --- */
        .sidebar {
            width: 320px;
            min-width: 320px;
            height: 100%;
            background: var(--sidebar-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            padding: 24px 20px;
            gap: 20px;
            overflow-y: auto;
            z-index: var(--z-sidebar);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
        }

        .app-title { font-size: 24px; font-weight: 700; margin: 0; letter-spacing: -0.5px; }
        .app-subtitle { font-size: 13px; color: var(--text-secondary); margin: 0; }

        .section { display: flex; flex-direction: column; gap: 8px; }
        .section-label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; margin-left: 4px; }

        /* --- –ö–ù–û–ü–ö–ò –ò –ö–û–ù–¢–†–û–õ–´ --- */
        .row { display: flex; gap: 10px; }
        .row > * { flex: 1; }

        button {
            border: none; height: 40px; border-radius: var(--radius-M);
            font-size: 15px; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background-color: var(--accent); color: white; box-shadow: 0 2px 8px rgba(0,122,255,0.25); }
        .btn-secondary { background-color: rgba(0,0,0,0.05); color: var(--text-primary); }
        .btn-danger { background-color: rgba(255, 59, 48, 0.1); color: var(--danger); }

        select {
            width: 100%; height: 40px; padding: 0 12px;
            border-radius: var(--radius-M); border: 1px solid rgba(0,0,0,0.1);
            background-color: rgba(255,255,255,0.6);
            font-size: 15px; color: var(--text-primary); outline: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007AFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 10px auto;
        }

        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        .btn-file { width: 100%; background: white; border: 1px dashed #ccc; color: var(--accent); }

        .tool-panel {
            background: white; padding: 8px 12px; border-radius: var(--radius-M);
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        input[type="color"] { border: none; width: 32px; height: 32px; padding: 0; background: none; cursor: pointer; border-radius: 50%; }
        input[type="number"] { width: 50px; border: none; text-align: right; font-size: 16px; font-weight: 600; color: var(--text-primary); outline: none; }

        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #E5E5EA; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-top: -8px; cursor: pointer; }

        /* --- ZOOM CONTROLS --- */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: var(--z-zoom);
        }
        .zoom-btn {
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 22px;
            color: var(--accent);
            padding: 0;
        }
        .zoom-btn:hover { background: #f0f0f0; }

        /* --- –ö–ù–û–ü–ö–ê –ú–ï–ù–Æ (–ì–ê–ú–ë–£–†–ì–ï–†) --- */
        .menu-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-menu-btn);
            color: var(--text-primary);
        }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
            z-index: var(--z-overlay);
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: all; }

        /* --- –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨ (CANVAS) --- */
        .main-area {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--app-bg);
            padding: 20px;
            overflow: hidden;
            width: 100%;
        }

        .canvas-container {
            width: 800px;
            height: 600px;
            background: white;
            border-radius: 4px; 
            box-shadow: var(--shadow-card);
            position: relative;
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 4/3; 
        }

        canvas {
            display: block; width: 100%; height: 100%;
            cursor: crosshair; touch-action: none;
        }

        .icon { width: 24px; height: 24px; fill: currentColor; }

        /* --- –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ (MOBILE) --- */
        @media (max-width: 850px) {
            .menu-btn { display: flex; }

            .sidebar {
                position: absolute;
                left: 0; top: 0; bottom: 0;
                transform: translateX(-100%);
                width: 280px;
                min-width: 280px;
                box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .close-btn { display: block; }

            .main-area { padding: 10px; }
            
            .zoom-controls { bottom: 60px; right: 10px; } /* –ü–æ–¥–Ω–∏–º–∞–µ–º –∑—É–º —á—É—Ç—å –≤—ã—à–µ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
        }

    </style>
</head>
<body>

    <button class="menu-btn" onclick="toggleMenu()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </button>

    <div class="overlay" onclick="closeMenu()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div>
                <h1 class="app-title">–ü—Ä–æ–ø–∏—Å–∏</h1>
                <p class="app-subtitle">–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø–∏—Å—å–º–∞ v2.8</p>
            </div>
            <button class="close-btn" onclick="closeMenu()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <div class="section">
            <div class="section-label">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
            <div class="row">
                <button class="btn-primary" onclick="startReplay(); closeMenuIfMobile()" id="replayBtn">
                    <svg class="icon" style="width:18px;height:18px;" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    –ü–æ–∫–∞–∑–∞—Ç—å
                </button>
                <button class="btn-secondary btn-danger" onclick="fullClear(); closeMenuIfMobile()">
                    <svg class="icon" style="width:18px;height:18px;" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>
            </div>
        </div>

        <div class="section">
            <div class="section-label">–≠–∫—Å–ø–æ—Ä—Ç</div>
            <div class="row">
                <button class="btn-secondary" onclick="downloadImage()">–§–æ—Ç–æ</button>
                <button class="btn-secondary" onclick="recordVideo()" id="recordBtn">–í–∏–¥–µ–æ</button>
            </div>
        </div>

        <div class="section">
            <div class="section-label">–õ–∏—Å—Ç</div>
            <select id="bgSelect" onchange="onBackgroundChange(); closeMenuIfMobile()">
                <option value="propisi" selected>–ö–æ—Å–∞—è –ª–∏–Ω–µ–π–∫–∞ (1 –∫–ª–∞—Å—Å)</option>
                <option value="lines">–û–±—ã—á–Ω–∞—è –ª–∏–Ω–µ–π–∫–∞</option>
                <option value="grid">–ö–ª–µ—Ç–∫–∞</option>
                <option value="none">–ß–∏—Å—Ç—ã–π –ª–∏—Å—Ç</option>
            </select>
            
            <div class="file-input-wrapper">
                <button class="btn-secondary btn-file">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–æ–Ω...</button>
                <input type="file" accept="image/*" onchange="handleImageUpload(this)">
            </div>
        </div>

        <div class="section">
            <div class="section-label">–†—É—á–∫–∞</div>
            <div class="tool-panel">
                <input type="color" id="color" value="#007AFF">
                <span style="font-size:13px; color:#8E8E93;">–¢–æ–ª—â–∏–Ω–∞:</span>
                <input type="number" id="width" value="4" min="1" max="30">
            </div>
        </div>

        <div class="section">
            <div class="section-label">–°–∫–æ—Ä–æ—Å—Ç—å</div>
            <input type="range" id="speed" min="1" max="10" value="5">
        </div>

        <div class="section" style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05);">
            <div class="section-label">–ü–æ–ª–µ–∑–Ω–æ–µ</div>
            <a href="https://market.yandex.ru/cc/8djm9v" rel="sponsored" target="_blank" style="text-decoration: none; color: inherit;">
                <div style="background: white; border-radius: 12px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 12px; transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.03);">
                    <div style="min-width: 44px; height: 44px; background: #FFCC00; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                        üõçÔ∏è
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <span style="font-size: 13px; font-weight: 600; line-height: 1.2;">–¢–æ–≤–∞—Ä—ã –¥–ª—è —à–∫–æ–ª—ã</span>
                        <span style="font-size: 11px; color: #8E8E93;">–í—ã–≥–æ–¥–Ω—ã–µ —Ü–µ–Ω—ã</span>
                        <span style="font-size: 11px; color: #007AFF; font-weight: 500; margin-top: 2px;">–ö—É–ø–∏—Ç—å –Ω–∞ –ú–∞—Ä–∫–µ—Ç–µ &rarr;</span>
                    </div>
                </div>
            </a>
        </div>

    </div>

    <div class="main-area">
        <div class="canvas-container">
            <canvas id="drawingCanvas" width="800" height="600"></canvas>
            
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="changeZoom(0.1)">+</button>
                <button class="zoom-btn" onclick="changeZoom(-0.1)">‚àí</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.overlay');
        
        let isDrawing = false;
        let allPaths = [];
        let currentPath = [];
        let isReplaying = false;
        let uploadedImageObj = null;
        let currentZoom = 1.0;

        window.onload = function() { redrawAll(); };

        // --- –ó–£–ú –õ–û–ì–ò–ö–ê ---
        function changeZoom(delta) {
            const newZoom = currentZoom + delta;
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑—É–º –æ—Ç 0.5x –¥–æ 3.0x
            if (newZoom >= 0.5 && newZoom <= 3.0) {
                currentZoom = newZoom;
                redrawAll();
            }
        }

        // --- –ú–û–ë–ò–õ–¨–ù–û–ï –ú–ï–ù–Æ ---
        function toggleMenu() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeMenu() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        function closeMenuIfMobile() {
            if (window.innerWidth <= 850) {
                closeMenu();
            }
        }

        // --- –§–û–ù–´ ---
        function onBackgroundChange() {
            uploadedImageObj = null;
            redrawAll();
        }

        function drawBackground() {
            const type = document.getElementById('bgSelect').value;
            // –£—á–∏—Ç—ã–≤–∞–µ–º –∑—É–º –ø—Ä–∏ –∑–∞–ª–∏–≤–∫–µ —Ñ–æ–Ω–∞, —á—Ç–æ–±—ã –ø–æ–∫—Ä—ã—Ç—å –≤—Å—é –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å
            const w = canvas.width / currentZoom;
            const h = canvas.height / currentZoom;

            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, w, h);

            if (uploadedImageObj) {
                ctx.drawImage(uploadedImageObj, 0, 0, w, h);
                return;
            }

            ctx.lineWidth = 1;

            if (type === 'lines') {
                ctx.beginPath();
                ctx.strokeStyle = '#999999';
                for (let y = 40; y < h; y += 40) { ctx.moveTo(0, y); ctx.lineTo(w, y); }
                ctx.stroke();
            } 
            else if (type === 'grid') {
                ctx.beginPath();
                ctx.strokeStyle = '#cfcfcf';
                for (let x = 20; x < w; x += 20) { ctx.moveTo(x, 0); ctx.lineTo(x, h); }
                for (let y = 20; y < h; y += 20) { ctx.moveTo(0, y); ctx.lineTo(w, y); }
                ctx.stroke();
            } 
            else if (type === 'propisi') {
                ctx.beginPath();
                ctx.strokeStyle = '#d1d1d1';
                const slantOffset = 280; 
                const step = 55;
                // –†–∏—Å—É–µ–º —Å –∑–∞–ø–∞—Å–æ–º, —á—Ç–æ–±—ã –ø—Ä–∏ –∑—É–º–µ –∏ —Å–¥–≤–∏–≥–µ –ª–∏–Ω–∏–∏ –Ω–µ –∫–æ–Ω—á–∞–ª–∏—Å—å
                for (let x = -slantOffset; x < w + slantOffset; x += step) {
                    ctx.moveTo(x + slantOffset, 0); ctx.lineTo(x, h);
                }
                ctx.stroke();

                ctx.beginPath();
                ctx.strokeStyle = '#8c8c8c';
                let y = 20;
                while (y < h) {
                    ctx.moveTo(0, y); ctx.lineTo(w, y);
                    ctx.moveTo(0, y + 26); ctx.lineTo(w, y + 26);
                    y += 80;
                }
                ctx.stroke();
            }
        }

        function redrawAll() {
            // –û—á–∏—â–∞–µ–º –í–ï–°–¨ —Ö–æ–ª—Å—Ç –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            ctx.save();
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–±
            ctx.scale(currentZoom, currentZoom);
            
            // –ï—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∞–Ω–∏–º–∞—Ü–∏—é, —Ñ–æ–Ω —É–∂–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω –≤ animate, —Ç—É—Ç –Ω–µ –º–µ—à–∞–µ–º
            if (!isReplaying) {
                drawBackground();
                allPaths.forEach(path => drawSinglePath(path));
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—á—Ç–æ–±—ã scale –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–ª—Å—è)
            ctx.restore();
        }

        function drawSinglePath(path) {
            if (path.points.length < 1) return;
            ctx.lineWidth = path.width;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = path.color;
            ctx.fillStyle = path.color;

            ctx.beginPath();
            if (path.points.length === 1) {
                ctx.arc(path.points[0].x, path.points[0].y, path.width / 2, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.moveTo(path.points[0].x, path.points[0].y);
                for (let i = 1; i < path.points.length; i++) {
                    ctx.lineTo(path.points[i].x, path.points[i].y);
                }
                ctx.stroke();
            }
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        uploadedImageObj = img;
                        document.getElementById('bgSelect').value = 'none';
                        redrawAll();
                        closeMenuIfMobile();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
                input.value = '';
            }
        }

        // --- –í–í–û–î (–ú–´–®–¨ + –¢–ê–ß) ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            // –†–µ–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (CSS-—Ä–∞–∑–º–µ—Ä vs —Ä–µ–∞–ª—å–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏)
            const cssScaleX = canvas.width / rect.width;
            const cssScaleY = canvas.height / rect.height;

            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            // –ë–∞–∑–æ–≤–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö —Ö–æ–ª—Å—Ç–∞
            const rawX = (clientX - rect.left) * cssScaleX;
            const rawY = (clientY - rect.top) * cssScaleY;

            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞ —Ç–µ–∫—É—â–∏–π –ó–£–ú, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É –≤ "–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º" 100% —Ä–∞–∑–º–µ—Ä–µ
            return { 
                x: rawX / currentZoom, 
                y: rawY / currentZoom 
            };
        }

        function startPath(e) {
            if (isReplaying) return;
            if (e.target.closest('.menu-btn')) return;
            if (e.target.closest('.zoom-controls')) return; // –ù–µ —Ä–∏—Å—É–µ–º, –µ—Å–ª–∏ –∂–º–µ–º –Ω–∞ –∑—É–º

            e.preventDefault();
            isDrawing = true;
            const point = getPos(e);
            currentPath = {
                color: document.getElementById('color').value,
                width: document.getElementById('width').value,
                points: [point]
            };
            
            // –†–∏—Å—É–µ–º —Ç–æ—á–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (—Å —É—á–µ—Ç–æ–º –∑—É–º–∞)
            ctx.save();
            ctx.scale(currentZoom, currentZoom);
            ctx.beginPath();
            ctx.fillStyle = currentPath.color;
            ctx.arc(point.x, point.y, currentPath.width / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        function movePath(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const point = getPos(e);
            currentPath.points.push(point);
            
            const points = currentPath.points;
            if (points.length > 1) {
                const prev = points[points.length - 2];
                
                // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é (—Å —É—á–µ—Ç–æ–º –∑—É–º–∞)
                ctx.save();
                ctx.scale(currentZoom, currentZoom);
                ctx.beginPath();
                ctx.lineWidth = currentPath.width;
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.strokeStyle = currentPath.color;
                ctx.moveTo(prev.x, prev.y);
                ctx.lineTo(point.x, point.y);
                ctx.stroke();
                ctx.restore();
            }
        }

        function endPath() {
            if (isDrawing) {
                isDrawing = false;
                allPaths.push(currentPath);
            }
        }

        canvas.addEventListener('mousedown', startPath);
        canvas.addEventListener('mousemove', movePath);
        canvas.addEventListener('mouseup', endPath);
        canvas.addEventListener('mouseleave', endPath);
        
        canvas.addEventListener('touchstart', startPath, { passive: false });
        canvas.addEventListener('touchmove', movePath, { passive: false });
        canvas.addEventListener('touchend', endPath);

        function fullClear() {
            if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –ª–∏—Å—Ç?')) {
                allPaths = [];
                uploadedImageObj = null;
                document.getElementById('bgSelect').value = 'propisi';
                redrawAll();
            }
        }

        // --- –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï ---
        function startReplay(onComplete) {
            if (allPaths.length === 0 || isReplaying) return;
            isReplaying = true;
            document.getElementById('replayBtn').disabled = true;
            
            // –ü–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ö–æ–ª—Å—Ç –∏ —Ä–∏—Å—É–µ–º —Ñ–æ–Ω
            // –í–∞–∂–Ω–æ: —Ñ–æ–Ω —Ä–∏—Å—É–µ–º —Å —É—á–µ—Ç–æ–º –∑—É–º–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.scale(currentZoom, currentZoom);
            drawBackground();
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Ç–∞–∫ –∫–∞–∫ animate() —Å–∞–º –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å scale?
            // –ù–µ—Ç, –ª—É—á—à–µ animate –¥–µ–ª–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ scale
            // –ù–æ animate –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π...
            ctx.restore();

            const speedInput = document.getElementById('speed');
            let pathIndex = 0;
            let pointIndex = 1;

            function animate() {
                if (pathIndex >= allPaths.length) {
                    isReplaying = false;
                    document.getElementById('replayBtn').disabled = false;
                    if (onComplete) onComplete();
                    // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —á—Ç–æ–±—ã –≤—Å–µ –±—ã–ª–æ —á–∏—Å—Ç–æ
                    redrawAll();
                    return;
                }
                const path = allPaths[pathIndex];
                
                // –í–∫–ª—é—á–∞–µ–º –∑—É–º –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                ctx.save();
                ctx.scale(currentZoom, currentZoom);
                
                ctx.lineWidth = path.width;
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.strokeStyle = path.color;
                ctx.fillStyle = path.color;

                if (pointIndex === 1) {
                    ctx.beginPath();
                    ctx.arc(path.points[0].x, path.points[0].y, path.width / 2, 0, Math.PI * 2);
                    ctx.fill();
                }

                if (pointIndex < path.points.length) {
                    const p1 = path.points[pointIndex - 1];
                    const p2 = path.points[pointIndex];
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                    pointIndex++;
                    ctx.restore(); // –í—ã—Ö–æ–¥–∏–º –∏–∑ –∑—É–º–∞ –ø–µ—Ä–µ–¥ —Ç–∞–π–º–∞—É—Ç–æ–º
                    setTimeout(animate, 25 / parseInt(speedInput.value));
                } else {
                    pathIndex++;
                    pointIndex = 1;
                    ctx.restore();
                    setTimeout(animate, 200 / parseInt(speedInput.value)); 
                }
            }
            animate();
        }

        function downloadImage() {
            redrawAll();
            const link = document.createElement('a');
            link.download = 'propisi-art.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            closeMenuIfMobile();
        }

        function recordVideo() {
            if (allPaths.length === 0) { alert("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!"); return; }
            closeMenuIfMobile();
            
            const btn = document.getElementById('recordBtn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '–ó–∞–ø–∏—Å—å...';
            btn.disabled = true;
            
            // –î–ª—è –≤–∏–¥–µ–æ –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑—É–º –≤ 100%, —á—Ç–æ–±—ã –≤–∏–¥–µ–æ –±—ã–ª–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º?
            // –ò–ª–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å? –õ–æ–≥–∏—á–Ω–µ–µ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ç–æ, —á—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∑—É–º).
            // –û—Å—Ç–∞–≤–∏–º —Ç–µ–∫—É—â–∏–π –∑—É–º.
            redrawAll();

            const stream = canvas.captureStream(30);
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            const chunks = [];
            recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = url; a.download = 'propisi-video.webm';
                document.body.appendChild(a); a.click();
                window.URL.revokeObjectURL(url);
                btn.innerHTML = originalContent;
                btn.disabled = false;
                redrawAll();
            };
            recorder.start();
            startReplay(() => { recorder.stop(); });
        }
    </script>
</body>
</html>
