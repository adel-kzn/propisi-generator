<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–∏—Å–æ–≤–∞–Ω–∏–µ –ü—Ä–æ–ø–∏—Å–µ–π (v8.0 Fixed)</title>

    <meta name="yandex-verification" content="zoqf7gn5mwyntin5" />
    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
       ym(106467293, "init", {clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true});
    </script>

    <style>
        :root {
            --app-bg: #Eef2F5;
            --sidebar-bg: #FFFFFF;
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
            --accent: #007AFF;
            --radius-M: 10px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--app-bg);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 360px; min-width: 360px; height: 100%;
            background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.1);
            display: flex; flex-direction: column; padding: 20px; gap: 15px;
            overflow-y: auto; z-index: 10;
        }
        .app-title { font-size: 20px; font-weight: 700; margin: 0; }
        .app-subtitle { font-size: 12px; color: var(--text-secondary); margin: 0; }
        
        .nav-tabs { display: flex; background: #F2F2F7; padding: 4px; border-radius: 10px; }
        .nav-tab { flex: 1; text-align: center; padding: 8px 12px; font-size: 13px; font-weight: 500; text-decoration: none; color: var(--text-primary); border-radius: 7px; transition: all 0.2s; }
        .nav-tab.active { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .section { display: flex; flex-direction: column; gap: 8px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .section-label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); }

        select, input[type=file] {
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #E5E5EA;
            background-color: white; font-size: 14px; outline: none;
        }

        /* –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã */
        .tools-row { display: flex; gap: 8px; }
        .tool-btn {
            flex: 1; padding: 10px; border: 1px solid #E5E5EA; border-radius: 8px;
            background: white; cursor: pointer; text-align: center; font-size: 13px; font-weight: 500;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
        }
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .tool-btn:active { transform: scale(0.98); }

        /* –ü–∞–ª–∏—Ç—Ä–∞ */
        .color-palette { display: flex; gap: 10px; justify-content: space-between; }
        .color-swatch {
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .color-swatch.active { border-color: #000; transform: scale(1.1); }

        /* –ó–£–ú –ö–û–ù–¢–†–û–õ–´ */
        .zoom-controls { display: flex; align-items: center; gap: 10px; background: #F2F2F7; padding: 5px; border-radius: 8px; }
        .zoom-btn {
            width: 36px; height: 36px; border: none; background: white; border-radius: 6px;
            font-size: 18px; font-weight: bold; cursor: pointer; color: var(--accent);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .zoom-btn:active { background: #e0e0e0; }
        .zoom-val { flex-grow: 1; text-align: center; font-size: 14px; font-weight: 600; color: var(--text-primary); }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button.btn-action {
            border: none; height: 40px; border-radius: 8px; font-weight: 600; font-size: 13px;
            cursor: pointer; background: #F2F2F7; color: var(--text-primary); transition: 0.2s;
        }
        button.btn-action:hover { background: #E5E5EA; }
        button.btn-primary { background: var(--accent); color: white; }
        button.btn-danger { background: #FF3B30; color: white; }
        
        /* --- MAIN AREA (Fix Centering) --- */
        .main-area {
            flex-grow: 1; 
            background-color: var(--app-bg); 
            /* Flexbox –¥–ª—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∏ */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: auto; /* –°–∫—Ä–æ–ª–ª –∑–¥–µ—Å—å */
            position: relative;
        }
        
        .canvas-wrapper {
            /* –†–∞–∑–º–µ—Ä—ã –∑–∞–¥–∞—é—Ç—Å—è JS-–æ–º */
            background: white;
            box-shadow: 0 4px 30px rgba(0,0,0,0.15);
            position: relative;
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å –º–µ–Ω—å—à–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ */
            margin: auto;   /* –ú–∞–≥–∏—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∏ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
        }

        canvas { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        #bgCanvas { z-index: 1; }
        #drawCanvas { z-index: 2; cursor: crosshair; }

        @media (max-width: 900px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            .sidebar { width: 100%; min-width: 0; height: auto; border-right: none; }
            .main-area { padding: 10px; display: block; overflow: scroll; }
            .canvas-wrapper { margin: 0 auto; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="app-header">
            <h1 class="app-title">–ü—Ä–æ–ø–∏—Å–∏</h1>
            <p class="app-subtitle">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ—Å–∫–∞ v8.0</p>
        </div>

        <div class="nav-tabs">
            <a href="index.html" class="nav-tab active">–†–∏—Å–æ–≤–∞–Ω–∏–µ</a>
            <a href="generator.html" class="nav-tab">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</a>
        </div>

        <div class="section">
            <div class="section-label">1. –ü–æ–¥–ª–æ–∂–∫–∞</div>
            <select id="bgSelect" onchange="changeBackground()">
                <option value="propisi_often" selected>–ß–∞—Å—Ç–∞—è –∫–æ—Å–∞—è (1 –∫–ª–∞—Å—Å)</option>
                <option value="propisi_rare">–†–µ–¥–∫–∞—è –∫–æ—Å–∞—è</option>
                <option value="lines">–û–±—ã—á–Ω–∞—è –ª–∏–Ω–µ–π–∫–∞</option>
                <option value="white">–ß–∏—Å—Ç—ã–π –ª–∏—Å—Ç</option>
                <option value="custom">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—ë —Ñ–æ—Ç–æ...</option>
            </select>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleImageUpload()">
        </div>

        <div class="section">
            <div class="section-label">2. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
            <div class="tools-row">
                <div class="tool-btn active" onclick="setTool('pen')" id="btnPen">üñä –†—É—á–∫–∞</div>
                <div class="tool-btn" onclick="setTool('eraser')" id="btnEraser">üßº –õ–∞—Å—Ç–∏–∫</div>
                <div class="tool-btn" onclick="undo()" title="–û—Ç–º–µ–Ω–∏—Ç—å">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞</div>
            </div>
            
            <div class="color-palette" id="palette">
                <div class="color-swatch active" style="background:#0055AA" onclick="setColor('#0055AA', this)"></div> <div class="color-swatch" style="background:#FF3B30" onclick="setColor('#FF3B30', this)"></div> <div class="color-swatch" style="background:#34C759" onclick="setColor('#34C759', this)"></div> <div class="color-swatch" style="background:#000000" onclick="setColor('#000000', this)"></div> </div>
            
            <div style="margin-top:5px;">
                <div class="section-label">–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏</div>
                <input type="range" id="lineWidth" min="1" max="15" value="4">
            </div>
        </div>

        <div class="section">
            <div class="section-label">3. –ó–∞–ø–∏—Å—å —É—Ä–æ–∫–∞</div>
            <button class="btn-action btn-primary" onclick="playRecording()">‚ñ∂Ô∏è –ü—Ä–æ–∏–≥—Ä–∞—Ç—å (–ö–∞–∫ —É—á–∏—Ç–µ–ª—å)</button>
            <div class="action-grid">
                 <button class="btn-action" onclick="exportVideo()">üìπ –í–∏–¥–µ–æ</button>
                 <button class="btn-action" onclick="downloadImage()">üì∑ –§–æ—Ç–æ</button>
            </div>
        </div>

        <div class="section" style="margin-top:auto;">
            <div class="section-label">–ú–∞—Å—à—Ç–∞–± (Zoom)</div>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="changeZoom(-0.1)">‚àí</button>
                <div class="zoom-val" id="zoomVal">100%</div>
                <button class="zoom-btn" onclick="changeZoom(0.1)">+</button>
            </div>
            <button class="btn-action btn-danger" style="margin-top:10px;" onclick="clearCanvas()">üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>
    </div>

    <div class="main-area">
        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="bgCanvas" width="2480" height="3508"></canvas>
            <canvas id="drawCanvas" width="2480" height="3508"></canvas>
        </div>
    </div>

    <script>
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        const drawCanvas = document.getElementById('drawCanvas');
        const drawCtx = drawCanvas.getContext('2d');
        const wrapper = document.getElementById('canvasWrapper');

        // –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è UNDO –∏ REPLAY
        let actions = []; 
        let currentStroke = null;
        
        let isDrawing = false;
        let tool = 'pen';
        let color = '#0055AA';
        let zoom = 1.0;
        let customImage = null; 

        const MM = 11.81;
        const ROW_H = 4 * MM; 
        const GAP_H = 8 * MM; 
        const MT = 20 * MM; 

        // –ë–∞–∑–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ A4 –≤ –ø–∏–∫—Å–µ–ª—è—Ö (–ø—Ä–∏ 300 DPI / scale factor)
        // –î–ª—è —ç–∫—Ä–∞–Ω–∞ –±–µ—Ä–µ–º –ø–æ–º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–º. 
        // 2480px - —ç—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω–æ.
        const BASE_WIDTH_PX = 794; // A4 @ 96 DPI approx
        const BASE_HEIGHT_PX = 1123;

        window.onload = function() {
            setZoom(1.0); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑—É–º–∞
            drawBackground();
            setupEvents();
        };

        // --- 1. –õ–û–ì–ò–ö–ê –§–û–ù–ê ---
        function changeBackground() {
            const val = document.getElementById('bgSelect').value;
            if (val === 'custom') {
                document.getElementById('fileInput').click();
            } else {
                customImage = null;
                drawBackground();
            }
        }

        function handleImageUpload() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        customImage = img;
                        drawBackground();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function drawBackground() {
            const w = bgCanvas.width;
            const h = bgCanvas.height;
            const type = document.getElementById('bgSelect').value;
            
            bgCtx.fillStyle = 'white';
            bgCtx.fillRect(0, 0, w, h);

            if (customImage) {
                bgCtx.drawImage(customImage, 0, 0, w, h);
                return;
            }

            if (type === 'white') return;

            // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
            bgCtx.lineWidth = 2;
            bgCtx.beginPath(); bgCtx.strokeStyle = '#FF8080'; bgCtx.lineWidth = 4;
            bgCtx.moveTo(20*MM, 0); bgCtx.lineTo(20*MM, h); bgCtx.stroke();
            
            const totalH = ROW_H + GAP_H;
            let y = MT;
            
            let slantStep = 0; 
            let drawSlant = false;
            if (type === 'propisi_often') { drawSlant = true; slantStep = 25 * MM; }
            else if (type === 'propisi_rare') { drawSlant = true; slantStep = 150 * MM; }

            bgCtx.lineWidth = 2;
            while(y < h - MT) {
                bgCtx.beginPath(); bgCtx.strokeStyle = '#5096F2';
                bgCtx.moveTo(0, y); bgCtx.lineTo(w, y); bgCtx.stroke();
                bgCtx.beginPath(); bgCtx.moveTo(0, y+ROW_H); bgCtx.lineTo(w, y+ROW_H); bgCtx.stroke();
                y += totalH;
            }
            
            if (drawSlant) {
                bgCtx.beginPath(); bgCtx.strokeStyle = '#D1D1D6';
                const tan = 0.466; 
                const shift = h * tan;
                for(let x = -shift; x < w; x += slantStep) {
                    bgCtx.moveTo(x + shift, 0); bgCtx.lineTo(x, h);
                }
                bgCtx.stroke();
            }
        }

        // --- 2. –õ–û–ì–ò–ö–ê –†–ò–°–û–í–ê–ù–ò–Ø ---
        function getCoords(e) {
            const rect = drawCanvas.getBoundingClientRect();
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ DOM-—ç–ª–µ–º–µ–Ω—Ç–∞
            let clientX = e.clientX;
            let clientY = e.clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            }

            const x = clientX - rect.left;
            const y = clientY - rect.top;

            // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ö–∞–Ω–≤–∞—Å–∞ (2480x3508)
            return {
                x: x * (drawCanvas.width / rect.width),
                y: y * (drawCanvas.height / rect.height)
            };
        }

        function startDraw(e) {
            isDrawing = true;
            const coords = getCoords(e);
            
            const width = document.getElementById('lineWidth').value * 2;
            currentStroke = {
                type: 'stroke',
                tool: tool,
                color: color,
                width: width,
                points: [ {x: coords.x, y: coords.y} ]
            };

            drawCtx.beginPath();
            drawCtx.lineCap = 'round';
            drawCtx.lineJoin = 'round';
            drawCtx.lineWidth = width;
            drawCtx.strokeStyle = (tool === 'eraser') ? 'rgba(0,0,0,1)' : color;
            drawCtx.globalCompositeOperation = (tool === 'eraser') ? 'destination-out' : 'source-over';
            
            if (tool === 'eraser') drawCtx.lineWidth = 60; 
            
            drawCtx.moveTo(coords.x, coords.y);
        }

        function moveDraw(e) {
            if (!isDrawing) return;
            e.preventDefault(); 
            const coords = getCoords(e);
            currentStroke.points.push({x: coords.x, y: coords.y});
            drawCtx.lineTo(coords.x, coords.y);
            drawCtx.stroke();
        }

        function endDraw() {
            if (isDrawing && currentStroke) {
                actions.push(currentStroke);
            }
            isDrawing = false;
            currentStroke = null;
            drawCtx.beginPath();
        }

        function setupEvents() {
            drawCanvas.addEventListener('mousedown', startDraw);
            drawCanvas.addEventListener('mousemove', moveDraw);
            drawCanvas.addEventListener('mouseup', endDraw);
            drawCanvas.addEventListener('mouseout', endDraw);
            drawCanvas.addEventListener('touchstart', startDraw, {passive: false});
            drawCanvas.addEventListener('touchmove', moveDraw, {passive: false});
            drawCanvas.addEventListener('touchend', endDraw);
        }

        // --- 3. –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ (Undo, Zoom, Color) ---
        function setTool(t) {
            tool = t;
            document.getElementById('btnPen').classList.toggle('active', t==='pen');
            document.getElementById('btnEraser').classList.toggle('active', t==='eraser');
        }

        function setColor(c, el) {
            color = c;
            tool = 'pen';
            setTool('pen');
            document.querySelectorAll('.color-swatch').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }

        // –ù–û–í–´–ô –ó–£–ú (–ß–µ—Ä–µ–∑ —Ä–∞–∑–º–µ—Ä—ã)
        function changeZoom(delta) {
            let newZoom = Math.round((zoom + delta) * 10) / 10;
            if (newZoom < 0.2) newZoom = 0.2;
            if (newZoom > 3.0) newZoom = 3.0;
            setZoom(newZoom);
        }

        function setZoom(z) {
            zoom = z;
            document.getElementById('zoomVal').innerText = Math.round(zoom * 100) + '%';
            
            // –ú–µ–Ω—è–µ–º CSS —Ä–∞–∑–º–µ—Ä—ã –æ–±–µ—Ä—Ç–∫–∏
            // –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å–∫—Ä–æ–ª–ª –∏ —Ü–µ–Ω—Ç—Ä–æ–≤–∫—É
            wrapper.style.width = (BASE_WIDTH_PX * zoom) + 'px';
            wrapper.style.height = (BASE_HEIGHT_PX * zoom) + 'px';
        }

        function undo() {
            if (actions.length === 0) return;
            actions.pop();
            redrawAll();
        }

        function clearCanvas() {
            if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏?')) {
                actions = [];
                drawCtx.clearRect(0,0, drawCanvas.width, drawCanvas.height);
            }
        }

        function redrawAll() {
            drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
            actions.forEach(act => {
                drawCtx.beginPath();
                drawCtx.lineCap = 'round';
                drawCtx.lineJoin = 'round';
                if (act.tool === 'eraser') {
                    drawCtx.globalCompositeOperation = 'destination-out';
                    drawCtx.lineWidth = 60;
                } else {
                    drawCtx.globalCompositeOperation = 'source-over';
                    drawCtx.strokeStyle = act.color;
                    drawCtx.lineWidth = act.width;
                }
                if (act.points.length > 0) {
                    drawCtx.moveTo(act.points[0].x, act.points[0].y);
                    for (let i = 1; i < act.points.length; i++) {
                        drawCtx.lineTo(act.points[i].x, act.points[i].y);
                    }
                    drawCtx.stroke();
                }
            });
        }

        // --- 4. –ú–ê–ì–ò–Ø: –ü–û–í–¢–û–† (REPLAY) ---
        let isReplaying = false;

        function playRecording() {
            if (actions.length === 0) return;
            if (isReplaying) return;
            isReplaying = true;
            drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
            
            let actionIdx = 0;
            let pointIdx = 0;

            function animate() {
                if (actionIdx >= actions.length) {
                    isReplaying = false;
                    return;
                }
                const act = actions[actionIdx];
                if (pointIdx === 0) {
                    drawCtx.beginPath();
                    drawCtx.lineCap = 'round';
                    drawCtx.lineJoin = 'round';
                    if (act.tool === 'eraser') {
                        drawCtx.globalCompositeOperation = 'destination-out';
                        drawCtx.lineWidth = 60;
                    } else {
                        drawCtx.globalCompositeOperation = 'source-over';
                        drawCtx.strokeStyle = act.color;
                        drawCtx.lineWidth = act.width;
                    }
                    if(act.points.length > 0) drawCtx.moveTo(act.points[0].x, act.points[0].y);
                    pointIdx = 1;
                }
                for(let k=0; k<5; k++) { // –°–∫–æ—Ä–æ—Å—Ç—å
                    if (pointIdx < act.points.length) {
                        drawCtx.lineTo(act.points[pointIdx].x, act.points[pointIdx].y);
                        drawCtx.stroke();
                        pointIdx++;
                    } else {
                        actionIdx++;
                        pointIdx = 0;
                        break;
                    }
                }
                if (isReplaying) requestAnimationFrame(animate);
            }
            animate();
        }

        // --- 5. –≠–ö–°–ü–û–†–¢ –í–ò–î–ï–û (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ---
        function exportVideo() {
            if (actions.length === 0) { alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!'); return; }
            
            // 1. –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–≤–∞—Å, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä–µ–¥–∏–Ω–∏—Ç –§–æ–Ω + –†–∏—Å–æ–≤–∞–Ω–∏–µ
            const recCanvas = document.createElement('canvas');
            recCanvas.width = bgCanvas.width;
            recCanvas.height = bgCanvas.height;
            const recCtx = recCanvas.getContext('2d');
            
            // 2. –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å —Å —ç—Ç–æ–≥–æ —Å–∫—Ä—ã—Ç–æ–≥–æ –∫–∞–Ω–≤–∞—Å–∞
            const stream = recCanvas.captureStream(30); 
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            const chunks = [];
            
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lesson.webm';
                a.click();
            };
            recorder.start();

            // 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞ –°–ö–†–´–¢–û–ú –∫–∞–Ω–≤–∞—Å–µ
            let actionIdx = 0;
            let pointIdx = 0;

            function animateRec() {
                if (actionIdx >= actions.length) {
                    recorder.stop();
                    return;
                }

                // –í –∫–∞–∂–¥–æ–º –∫–∞–¥—Ä–µ:
                // –ê) –†–∏—Å—É–µ–º —Ñ–æ–Ω (–∏–Ω–∞—á–µ –±—É–¥–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –∏–ª–∏ —Å–ª–µ–¥—ã —Å—Ç–∏—Ä–∞–Ω–∏—è)
                // –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã —Ö–æ—Ç–∏–º –≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Ä–∏—Å–æ–≤–∞–Ω–∏—è, –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ —Å—Ç–∏—Ä–∞—Ç—å –≤—Å—ë –∫–∞–∂–¥—ã–π —Ä–∞–∑.
                // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å —Ñ–æ–Ω –û–î–ò–ù —Ä–∞–∑ –≤ –Ω–∞—á–∞–ª–µ? –ù–µ—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å –ª–∞—Å—Ç–∏–∫!
                // –ï—Å–ª–∏ –µ—Å—Ç—å –ª–∞—Å—Ç–∏–∫, –æ–Ω —Å–æ—Ç—Ä–µ—Ç —Ñ–æ–Ω –¥–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏.
                // –ü–û–≠–¢–û–ú–£: –ö–∞–∂–¥—ã–π –∫–∞–¥—Ä –º—ã —Ä–∏—Å—É–µ–º —Ñ–æ–Ω, –∞ –ø–æ—Ç–æ–º –ø–æ–≤–µ—Ä—Ö —Ä–∏—Å—É–µ–º –í–°–ï –ª–∏–Ω–∏–∏ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞.
                // –≠—Ç–æ –º–µ–¥–ª–µ–Ω–Ω–æ.
                
                // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø:
                // –†–∏—Å—É–µ–º —Ñ–æ–Ω –æ–¥–∏–Ω —Ä–∞–∑.
                // –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä—É—á–∫–∞ -> –ø—Ä–æ—Å—Ç–æ —Ä–∏—Å—É–µ–º.
                // –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ª–∞—Å—Ç–∏–∫ -> –ø—Ä–æ–±–ª–µ–º–∞, –æ–Ω —Å–æ—Ç—Ä–µ—Ç —Ñ–æ–Ω.
                // –†–ï–®–ï–ù–ò–ï: –õ–∞—Å—Ç–∏–∫ –≤ —Ä–µ–∂–∏–º–µ "Video" –¥–æ–ª–∂–µ–Ω —Ä–∏—Å–æ–≤–∞—Ç—å —Ü–≤–µ—Ç–æ–º —Ñ–æ–Ω–∞? –ù–µ—Ç, —Ç–∞–º —Å–µ—Ç–∫–∞.
                // –ü—Ä–æ—Å—Ç–æ–π –ø—É—Ç—å: –ö–∞–∂–¥—ã–π –∫–∞–¥—Ä –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω (drawImage bgCanvas) –∏ —Ä–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ –ø–æ–≤–µ—Ä—Ö.
                
                recCtx.drawImage(bgCanvas, 0, 0); // –†–∏—Å—É–µ–º —Ñ–æ–Ω
                
                // –†–∏—Å—É–µ–º —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —à—Ç—Ä–∏—Ö–∏
                for(let i=0; i<actionIdx; i++) {
                    drawStrokeOnCtx(recCtx, actions[i]);
                }
                
                // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π (–∞–Ω–∏–º–∏—Ä—É–µ–º—ã–π) —à—Ç—Ä–∏—Ö —á–∞—Å—Ç–∏—á–Ω–æ
                const act = actions[actionIdx];
                const partialAct = {
                    ...act,
                    points: act.points.slice(0, pointIdx + 1)
                };
                drawStrokeOnCtx(recCtx, partialAct);

                // –î–≤–∏–≥–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                pointIdx += 5; // –°–∫–æ—Ä–æ—Å—Ç—å
                if (pointIdx >= act.points.length) {
                    actionIdx++;
                    pointIdx = 0;
                }
                
                requestAnimationFrame(animateRec);
            }
            
            animateRec();
            alert('–ó–∞–ø–∏—Å—å –ø–æ—à–ª–∞... –ü–æ–¥–æ–∂–¥–∏—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏.');
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —à—Ç—Ä–∏—Ö–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
        function drawStrokeOnCtx(ctx, act) {
            ctx.beginPath();
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            if (act.tool === 'eraser') {
                // –í–ê–ñ–ù–û: –ù–∞ –∫–æ–º–ø–æ–∑–∏—Ç–Ω–æ–º –∫–∞–Ω–≤–∞—Å–µ destination-out —Å–æ—Ç—Ä–µ—Ç –∏ —Ñ–æ–Ω —Ç–æ–∂–µ!
                // –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –≤–∏–¥–µ–æ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –≤ —ç—Ç–æ–º –º–µ—Å—Ç–µ.
                // –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º "—Å—Ç–µ—Ä–µ—Ç—å —á–µ—Ä–Ω–∏–ª–∞, –Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–ª–µ—Ç–∫—É", —ç—Ç–æ —Å–ª–æ–∂–Ω–µ–µ.
                // –ü—Ä–æ—â–µ –¥–ª—è –≤–∏–¥–µ–æ: eraser —Å—Ç–∏—Ä–∞–µ—Ç –≤—Å—ë –¥–æ –±–µ–ª–æ–≥–æ/–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ.
                // –ß—Ç–æ–±—ã –≤–∏–¥–µ–æ –±—ã–ª–æ –∫—Ä–∞—Å–∏–≤—ã–º, –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ —Ä–∏—Å–æ–≤–∞—Ç—å "–±–µ–ª—ã–º" –ø–æ–≤–µ—Ä—Ö? –ù–µ—Ç, —Å–µ—Ç–∫–∞ –ø—Ä–æ–ø–∞–¥–µ—Ç.
                // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å—Ç–∏—Ä–∞–Ω–∏–µ. –í –≤–∏–¥–µ–æ –≤ –º–µ—Å—Ç–∞—Ö –ª–∞—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å/–±–µ–ª–æ–µ.
                // –ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å —Å–µ—Ç–∫—É, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å —Å–µ—Ç–∫—É –ø–æ–≤–µ—Ä—Ö —Å—Ç–µ—Ä—Ç–æ–≥–æ? –°–ª–æ–∂–Ω–æ.
                // –û—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å: –ª–∞—Å—Ç–∏–∫ —Å—Ç–∏—Ä–∞–µ—Ç –≤—Å—ë.
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 60;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = act.color;
                ctx.lineWidth = act.width;
            }
            if(act.points.length > 0) {
                ctx.moveTo(act.points[0].x, act.points[0].y);
                for (let i = 1; i < act.points.length; i++) {
                    ctx.lineTo(act.points[i].x, act.points[i].y);
                }
                ctx.stroke();
            }
        }

        function downloadImage() {
            const temp = document.createElement('canvas');
            temp.width = bgCanvas.width;
            temp.height = bgCanvas.height;
            const tCtx = temp.getContext('2d');
            tCtx.drawImage(bgCanvas, 0, 0);
            tCtx.drawImage(drawCanvas, 0, 0);
            const link = document.createElement('a');
            link.download = 'propisi_page.jpg';
            link.href = temp.toDataURL('image/jpeg', 0.9);
            link.click();
        }
    </script>
</body>
</html>
