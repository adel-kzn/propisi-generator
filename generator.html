<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Генератор прописей (Калибровка New)</title>

    <meta name="yandex-verification" content="zoqf7gn5mwyntin5" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* ПОДКЛЮЧАЕМ НОВЫЙ ШРИФТ */
        @font-face {
            font-family: 'PropisiParatype';
            src: url('Propisi Regular.otf') format('opentype');
            font-display: swap;
        }

        :root {
            --app-bg: #Eef2F5;
            --sidebar-bg: #FFFFFF;
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
            --accent: #007AFF;
            --radius-M: 10px;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--app-bg); height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 360px; min-width: 360px; background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; padding: 20px; gap: 15px; overflow-y: auto; }
        .app-title { font-size: 20px; font-weight: 700; margin: 0; }
        .section { display: flex; flex-direction: column; gap: 6px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .section-label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); }
        select, textarea, input[type=range] { width: 100%; border-radius: 8px; border: 1px solid #E5E5EA; background-color: white; font-size: 14px; outline: none; }
        select { padding: 10px; height: 40px; }
        textarea { padding: 10px; height: 100px; resize: none; font-family: inherit; }
        .main-area { flex-grow: 1; background-color: var(--app-bg); padding: 30px; display: flex; justify-content: center; align-items: flex-start; overflow-y: auto; }
        .a4-container { width: 100%; max-width: 800px; aspect-ratio: 210 / 297; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        canvas { width: 100%; height: 100%; display: block; }
        
        /* Debug Box Style */
        .debug-box {
            background: #FFF8C5; border: 1px solid #E0D060; color: #554400;
            padding: 10px; border-radius: 8px; font-family: monospace; font-size: 14px;
            text-align: center; margin-top: 10px;
        }
        .debug-val { font-weight: bold; font-size: 16px; color: #000; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div><h1 class="app-title">Калибровка (Paratype)</h1></div>

        <div class="section">
            <div class="section-label">Разлиновка</div>
            <select id="bgSelect" onchange="updatePreview()">
                <option value="propisi_often" selected>Частая косая</option>
                <option value="propisi_rare">Редкая косая</option>
                <option value="lines">Обычная линейка</option>
            </select>
        </div>

        <div class="section">
            <div class="section-label">Текст</div>
            <textarea id="textInput" oninput="updatePreview()">ааа ббб
АБВ Где</textarea>
        </div>

        <div class="section" style="background: #F2F2F7; padding: 10px; border-radius: 10px;">
            <div class="section-label" style="color: #007AFF;">Настройки (Двигай ползунки!)</div>
            
            <div style="margin-top: 10px;">
                <label>Размер шрифта:</label>
                <input type="range" id="fontSizeRange" min="50" max="400" value="150" oninput="updatePreview()">
            </div>
            
            <div style="margin-top: 10px;">
                <label>Сдвиг (Вверх/Вниз):</label>
                <input type="range" id="offsetRange" min="-100" max="100" value="0" oninput="updatePreview()">
            </div>
            
            <div style="margin-top: 10px;">
                 <label>Интервал букв:</label>
                 <input type="range" id="spacingRange" min="-10" max="20" value="0" oninput="updatePreview()">
            </div>
        </div>

        <div class="debug-box">
            Сообщи мне эти числа:<br>
            Размер: <span id="outSize" class="debug-val">150</span><br>
            Сдвиг: <span id="outOffset" class="debug-val">0</span>
        </div>
        
         <div class="section">
             <div id="status" style="text-align: center; font-size: 11px; color: #8E8E93; margin-top: 5px;">Загрузка шрифта...</div>
        </div>
    </div>

    <div class="main-area">
        <div class="a4-container">
            <canvas id="previewCanvas" width="2480" height="3508"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        // Используем новое имя
        const fontName = 'PropisiParatype';
        const fontFile = 'Propisi Regular.otf';
        
        let currentFontSize = 150;
        let currentOffset = 0;

        window.onload = async function() {
            try {
                // Загружаем OTF
                const f = new FontFace(fontName, `url("${fontFile}")`);
                await f.load();
                document.fonts.add(f);
                document.getElementById('status').innerText = 'Шрифт Paratype загружен!';
                updatePreview();
            } catch(e) { 
                console.log(e); 
                document.getElementById('status').innerText = 'Ошибка: положите файл ' + fontFile + ' рядом!';
            }
        };

        function updatePreview() {
            // 1. Считываем значения ползунков
            currentFontSize = parseInt(document.getElementById('fontSizeRange').value);
            currentOffset = parseInt(document.getElementById('offsetRange').value);
            const letterSpacing = parseInt(document.getElementById('spacingRange').value);

            // 2. Выводим их в желтое окошко
            document.getElementById('outSize').innerText = currentFontSize;
            document.getElementById('outOffset').innerText = currentOffset;

            const w = canvas.width;
            const h = canvas.height;
            const type = document.getElementById('bgSelect').value;
            const text = document.getElementById('textInput').value;

            // Константы (в пикселях для Canvas 2480x3508)
            const MM = 11.81;
            const rowH = 4 * MM;
            const gapH = 8 * MM;
            const mt = 20 * MM;
            const ml = 20 * MM;

            // Очистка
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, w, h);

            // Рисуем разлиновку
            ctx.lineWidth = 2;
            const totalH = rowH + gapH;
            let y = mt;
            
            // Розовая черта полей
            ctx.beginPath(); ctx.strokeStyle = '#FF8080'; ctx.lineWidth = 4;
            ctx.moveTo(ml, 0); ctx.lineTo(ml, h); ctx.stroke();

            // Линейки
            ctx.lineWidth = 2;
            while (y < h - mt) {
                // Верхняя (Голубая)
                ctx.beginPath(); ctx.strokeStyle = '#5096F2'; 
                ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
                
                // Нижняя (Голубая)
                ctx.beginPath(); ctx.moveTo(0, y + rowH); ctx.lineTo(w, y + rowH); ctx.stroke();
                y += totalH;
            }
            
            // Косая сетка
            if (type.includes('propisi')) {
                const step = (type === 'propisi_often' ? 25 : 150) * MM;
                ctx.beginPath(); ctx.strokeStyle = '#D1D1D6';
                const shift = h * 0.466;
                for (let x = -shift; x < w; x += step) {
                    ctx.moveTo(x + shift, 0); ctx.lineTo(x, h);
                }
                ctx.stroke();
            }

            // Рисуем текст
            if (text) {
                ctx.font = `${currentFontSize}px "${fontName}"`;
                ctx.fillStyle = 'black';
                ctx.textBaseline = 'alphabetic';
                
                // ВКЛЮЧАЕМ ЛИГАТУРЫ (если они есть в шрифте)
                canvas.style.fontFeatureSettings = '"liga" 1, "calt" 1';
                ctx.letterSpacing = `${letterSpacing}px`;

                const lines = text.split('\n');
                const fullRowH = rowH + gapH;

                lines.forEach((line, i) => {
                    // Базовая позиция (нижняя линейка) + СДВИГ ИЗ ПОЛЗУНКА
                    let lineY = mt + (i * fullRowH) + rowH + currentOffset;
                    ctx.fillText(line, ml + 20, lineY);
                });
            }
        }
    </script>
</body>
</html>
