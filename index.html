<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Тренажер письма</title>

    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106467293', 'ym');

        ym(106467293, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", referrer: document.referrer, url: location.href, accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/106467293" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <style>
        /* --- APPLE / MACOS STYLE SYSTEM --- */
        :root {
            --app-bg: #F2F2F7;
            --sidebar-bg: rgba(255, 255, 255, 0.85);
            --sidebar-border: rgba(0, 0, 0, 0.05);
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
            --accent: #007AFF;
            --accent-hover: #0062cc;
            --danger: #FF3B30;
            --radius-L: 16px;
            --radius-M: 10px;
            --shadow-card: 0 8px 40px rgba(0, 0, 0, 0.12);
            --z-sidebar: 1000;
            --z-overlay: 900;
            --z-menu-btn: 800;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--app-bg);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* --- ЛЕВАЯ ПАНЕЛЬ (SIDEBAR) --- */
        .sidebar {
            width: 320px;
            min-width: 320px;
            height: 100%;
            background: var(--sidebar-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            padding: 24px 20px;
            gap: 20px;
            overflow-y: auto;
            z-index: var(--z-sidebar);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
        }

        .app-title { font-size: 24px; font-weight: 700; margin: 0; letter-spacing: -0.5px; }
        .app-subtitle { font-size: 13px; color: var(--text-secondary); margin: 0; }

        .section { display: flex; flex-direction: column; gap: 8px; }
        .section-label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; margin-left: 4px; }

        /* --- КНОПКИ И КОНТРОЛЫ --- */
        .row { display: flex; gap: 10px; }
        .row > * { flex: 1; }

        button {
            border: none; height: 40px; border-radius: var(--radius-M);
            font-size: 15px; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background-color: var(--accent); color: white; box-shadow: 0 2px 8px rgba(0,122,255,0.25); }
        .btn-secondary { background-color: rgba(0,0,0,0.05); color: var(--text-primary); }
        .btn-danger { background-color: rgba(255, 59, 48, 0.1); color: var(--danger); }

        select {
            width: 100%; height: 40px; padding: 0 12px;
            border-radius: var(--radius-M); border: 1px solid rgba(0,0,0,0.1);
            background-color: rgba(255,255,255,0.6);
            font-size: 15px; color: var(--text-primary); outline: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007AFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 10px auto;
        }

        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        .btn-file { width: 100%; background: white; border: 1px dashed #ccc; color: var(--accent); }

        .tool-panel {
            background: white; padding: 8px 12px; border-radius: var(--radius-M);
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        input[type="color"] { border: none; width: 32px; height: 32px; padding: 0; background: none; cursor: pointer; border-radius: 50%; }
        input[type="number"] { width: 50px; border: none; text-align: right; font-size: 16px; font-weight: 600; color: var(--text-primary); outline: none; }

        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #E5E5EA; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-top: -8px; cursor: pointer; }

        /* --- КНОПКА МЕНЮ (ГАМБУРГЕР) --- */
        .menu-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-menu-btn);
            color: var(--text-primary);
        }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
            z-index: var(--z-overlay);
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: all; }

        /* --- ПРАВАЯ ЧАСТЬ (CANVAS) --- */
        .main-area {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--app-bg);
            padding: 20px;
            overflow: hidden;
            width: 100%;
        }

        .canvas-container {
            width: 800px;
            height: 600px;
            background: white;
            border-radius: 4px; 
            box-shadow: var(--shadow-card);
            position: relative;
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 4/3; 
        }

        canvas {
            display: block; width: 100%; height: 100%;
            cursor: crosshair; touch-action: none;
        }

        .icon { width: 24px; height: 24px; fill: currentColor; }

        /* --- АДАПТИВНОСТЬ (MOBILE) --- */
        @media (max-width: 850px) {
            .menu-btn { display: flex; }

            .sidebar {
                position: absolute;
                left: 0; top: 0; bottom: 0;
                transform: translateX(-100%);
                width: 280px;
                min-width: 280px;
                box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .close-btn { display: block; }

            .main-area { padding: 10px; }
        }

    </style>
</head>
<body>

    <button class="menu-btn" onclick="toggleMenu()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </button>

    <div class="overlay" onclick="closeMenu()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div>
                <h1 class="app-title">Прописи</h1>
                <p class="app-subtitle">Тренажер письма v2.5</p>
            </div>
            <button class="close-btn" onclick="closeMenu()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <div class="section">
            <div class="section-label">Управление</div>
            <div class="row">
                <button class="btn-primary" onclick="startReplay(); closeMenuIfMobile()" id="replayBtn">
                    <svg class="icon" style="width:18px;height:18px;" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    Показать
                </button>
                <button class="btn-secondary btn-danger" onclick="fullClear(); closeMenuIfMobile()">
                    <svg class="icon" style="width:18px;height:18px;" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>
            </div>
        </div>

        <div class="section">
            <div class="section-label">Экспорт</div>
            <div class="row">
                <button class="btn-secondary" onclick="downloadImage()">Фото</button>
                <button class="btn-secondary" onclick="recordVideo()" id="recordBtn">Видео</button>
            </div>
        </div>

        <div class="section">
            <div class="section-label">Лист</div>
            <select id="bgSelect" onchange="onBackgroundChange(); closeMenuIfMobile()">
                <option value="propisi" selected>Косая линейка (1 класс)</option>
                <option value="lines">Обычная линейка</option>
                <option value="grid">Клетка</option>
                <option value="none">Чистый лист</option>
            </select>
            
            <div class="file-input-wrapper">
                <button class="btn-secondary btn-file">Загрузить свой фон...</button>
                <input type="file" accept="image/*" onchange="handleImageUpload(this)">
            </div>
        </div>

        <div class="section">
            <div class="section-label">Ручка</div>
            <div class="tool-panel">
                <input type="color" id="color" value="#007AFF">
                <span style="font-size:13px; color:#8E8E93;">Толщина:</span>
                <input type="number" id="width" value="4" min="1" max="30">
            </div>
        </div>

        <div class="section">
            <div class="section-label">Скорость</div>
            <input type="range" id="speed" min="1" max="10" value="5">
        </div>
    </div>

    <div class="main-area">
        <div class="canvas-container">
            <canvas id="drawingCanvas" width="800" height="600"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.overlay');
        
        let isDrawing = false;
        let allPaths = [];
        let currentPath = [];
        let isReplaying = false;
        let uploadedImageObj = null;

        window.onload = function() { redrawAll(); };

        // --- МОБИЛЬНОЕ МЕНЮ ---
        function toggleMenu() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeMenu() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        function closeMenuIfMobile() {
            if (window.innerWidth <= 850) {
                closeMenu();
            }
        }

        // --- ФОНЫ ---
        function onBackgroundChange() {
            uploadedImageObj = null;
            redrawAll();
        }

        function drawBackground() {
            const type = document.getElementById('bgSelect').value;
            const w = canvas.width;
            const h = canvas.height;

            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, w, h);

            if (uploadedImageObj) {
                ctx.drawImage(uploadedImageObj, 0, 0, w, h);
                return;
            }

            ctx.lineWidth = 1;

            if (type === 'lines') {
                ctx.beginPath();
                ctx.strokeStyle = '#999999';
                for (let y = 40; y < h; y += 40) { ctx.moveTo(0, y); ctx.lineTo(w, y); }
                ctx.stroke();
            } 
            else if (type === 'grid') {
                ctx.beginPath();
                ctx.strokeStyle = '#cfcfcf';
                for (let x = 20; x < w; x += 20) { ctx.moveTo(x, 0); ctx.lineTo(x, h); }
                for (let y = 20; y < h; y += 20) { ctx.moveTo(0, y); ctx.lineTo(w, y); }
                ctx.stroke();
            } 
            else if (type === 'propisi') {
                ctx.beginPath();
                ctx.strokeStyle = '#d1d1d1';
                const slantOffset = 280; 
                const step = 55;
                for (let x = -slantOffset; x < w + slantOffset; x += step) {
                    ctx.moveTo(x + slantOffset, 0); ctx.lineTo(x, h);
                }
                ctx.stroke();

                ctx.beginPath();
                ctx.strokeStyle = '#8c8c8c';
                let y = 20;
                while (y < h) {
                    ctx.moveTo(0, y); ctx.lineTo(w, y);
                    ctx.moveTo(0, y + 26); ctx.lineTo(w, y + 26);
                    y += 80;
                }
                ctx.stroke();
            }
        }

        function redrawAll() {
            if (isReplaying) return;
            drawBackground();
            allPaths.forEach(path => drawSinglePath(path));
        }

        function drawSinglePath(path) {
            if (path.points.length < 1) return;
            ctx.lineWidth = path.width;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = path.color;
            ctx.fillStyle = path.color;

            ctx.beginPath();
            if (path.points.length === 1) {
                ctx.arc(path.points[0].x, path.points[0].y, path.width / 2, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.moveTo(path.points[0].x, path.points[0].y);
                for (let i = 1; i < path.points.length; i++) {
                    ctx.lineTo(path.points[i].x, path.points[i].y);
                }
                ctx.stroke();
            }
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        uploadedImageObj = img;
                        document.getElementById('bgSelect').value = 'none';
                        redrawAll();
                        closeMenuIfMobile();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
                input.value = '';
            }
        }

        // --- ВВОД (МЫШЬ + ТАЧ) ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return { 
                x: (clientX - rect.left) * scaleX, 
                y: (clientY - rect.top) * scaleY 
            };
        }

        function startPath(e) {
            if (isReplaying) return;
            if (e.target.closest('.menu-btn')) return;

            e.preventDefault();
            isDrawing = true;
            const point = getPos(e);
            currentPath = {
                color: document.getElementById('color').value,
                width: document.getElementById('width').value,
                points: [point]
            };
            ctx.beginPath();
            ctx.fillStyle = currentPath.color;
            ctx.arc(point.x, point.y, currentPath.width / 2, 0, Math.PI * 2);
            ctx.fill();
        }

        function movePath(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const point = getPos(e);
            currentPath.points.push(point);
            
            const points = currentPath.points;
            if (points.length > 1) {
                const prev = points[points.length - 2];
                ctx.beginPath();
                ctx.lineWidth = currentPath.width;
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.strokeStyle = currentPath.color;
                ctx.moveTo(prev.x, prev.y);
                ctx.lineTo(point.x, point.y);
                ctx.stroke();
            }
        }

        function endPath() {
            if (isDrawing) {
                isDrawing = false;
                allPaths.push(currentPath);
            }
        }

        canvas.addEventListener('mousedown', startPath);
        canvas.addEventListener('mousemove', movePath);
        canvas.addEventListener('mouseup', endPath);
        canvas.addEventListener('mouseleave', endPath);
        
        canvas.addEventListener('touchstart', startPath, { passive: false });
        canvas.addEventListener('touchmove', movePath, { passive: false });
        canvas.addEventListener('touchend', endPath);

        function fullClear() {
            if(confirm('Очистить весь лист?')) {
                allPaths = [];
                uploadedImageObj = null;
                document.getElementById('bgSelect').value = 'propisi';
                redrawAll();
            }
        }

        // --- ВОСПРОИЗВЕДЕНИЕ ---
        function startReplay(onComplete) {
            if (allPaths.length === 0 || isReplaying) return;
            isReplaying = true;
            document.getElementById('replayBtn').disabled = true;
            drawBackground(); 

            const speedInput = document.getElementById('speed');
            let pathIndex = 0;
            let pointIndex = 1;

            function animate() {
                if (pathIndex >= allPaths.length) {
                    isReplaying = false;
                    document.getElementById('replayBtn').disabled = false;
                    if (onComplete) onComplete();
                    return;
                }
                const path = allPaths[pathIndex];
                ctx.lineWidth = path.width;
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.strokeStyle = path.color;
                ctx.fillStyle = path.color;

                if (pointIndex === 1) {
                    ctx.beginPath();
                    ctx.arc(path.points[0].x, path.points[0].y, path.width / 2, 0, Math.PI * 2);
                    ctx.fill();
                }

                if (pointIndex < path.points.length) {
                    const p1 = path.points[pointIndex - 1];
                    const p2 = path.points[pointIndex];
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                    pointIndex++;
                    setTimeout(animate, 25 / parseInt(speedInput.value));
                } else {
                    pathIndex++;
                    pointIndex = 1;
                    setTimeout(animate, 200 / parseInt(speedInput.value)); 
                }
            }
            animate();
        }

        function downloadImage() {
            redrawAll();
            const link = document.createElement('a');
            link.download = 'propisi-art.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            closeMenuIfMobile();
        }

        function recordVideo() {
            if (allPaths.length === 0) { alert("Сначала напишите что-нибудь!"); return; }
            closeMenuIfMobile();
            
            const btn = document.getElementById('recordBtn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = 'Запись...';
            btn.disabled = true;
            
            drawBackground();

            const stream = canvas.captureStream(30);
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            const chunks = [];
            recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = url; a.download = 'propisi-video.webm';
                document.body.appendChild(a); a.click();
                window.URL.revokeObjectURL(url);
                btn.innerHTML = originalContent;
                btn.disabled = false;
                redrawAll();
            };
            recorder.start();
            startReplay(() => { recorder.stop(); });
        }
    </script>
</body>
</html>
