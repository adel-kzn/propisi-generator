<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ—Å–∫–∞ –ø—Ä–æ–ø–∏—Å–µ–π | Propisi.site</title>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
       ym(106467293, "init", {clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true});
    </script>

    <style>
        @font-face { font-family: 'PrimoFont'; src: url('primo.ttf'); }
        :root { 
            --ink: #007AFF; --paper: #FFFFFF; --text: #1D1D1F; --sidebar-bg: #FFFFFF; --accent: #007AFF; --header-h: 60px; --footer-h: 50px;
        }
        * { box-sizing: border-box; touch-action: none; }
        body { 
            margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #Eef2F5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* 1. –®–ê–ü–ö–ê */
        header {
            height: var(--header-h); background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px); border-bottom: 1px solid rgba(0,0,0,0.06);
            flex-shrink: 0; display: flex; align-items: center; z-index: 1100;
        }
        .header-container { width: 100%; max-width: 1000px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: 'PrimoFont', cursive; font-size: 28px; color: var(--ink); text-decoration: none; text-shadow: 0 1px 0 #fff; white-space: nowrap; }
        .top-menu { display: flex; gap: 15px; }
        .top-menu a { text-decoration: none; color: #333; font-weight: 500; font-size: 14px; transition: 0.2s; padding: 5px 8px; border-radius: 6px; }
        .top-menu a:hover { color: var(--ink); background: rgba(0,122,255,0.05); }

        /* 2. –ü–†–ò–õ–û–ñ–ï–ù–ò–ï */
        .app-body { display: flex; flex: 1; overflow: hidden; position: relative; }

        .toggle-btn { 
            position: absolute; top: 10px; right: -54px;
            width: 44px; height: 44px; background: white; border-radius: 10px;
            box-shadow: 4px 0 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; border: 1px solid #eee; cursor: pointer;
            z-index: 2000; color: var(--accent);
        }

        .sidebar { 
            width: 360px; min-width: 360px; height: 100%; 
            background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.1);
            display: flex; flex-direction: column; padding: 20px; padding-top: 60px;
            gap: 15px; overflow-y: auto; z-index: 1000; transition: transform 0.3s;
            position: relative;
        }
        .sidebar.closed { transform: translateX(-100%); }

        .main-area { 
            flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: auto; position: relative;
            /* –ù–∞—à —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ–Ω */
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='120' viewBox='0 0 40 120' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='grid' x='0' y='0' width='40' height='120' patternUnits='userSpaceOnUse'%3E%3Cpath d='M0,120 L40,0' stroke='%23D9D9D9' stroke-width='1' fill='none'/%3E%3Cline x1='0' y1='30' x2='40' y2='30' stroke='%238CA6D6' stroke-width='1'/%3E%3Cline x1='0' y1='60' x2='40' y2='60' stroke='%238CA6D6' stroke-width='1'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23grid)'/%3E%3C/svg%3E");
            background-size: 40px 120px;
        }
        .canvas-wrapper { background: white; box-shadow: 0 10px 40px rgba(0,0,0,0.1); position: relative; flex-shrink: 0; margin: auto; }
        canvas { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        #bgCanvas { z-index: 1; }
        #drawCanvas { z-index: 2; cursor: crosshair; }

        .section { display: flex; flex-direction: column; gap: 8px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .section-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #8E8E93; letter-spacing: 0.5px; }
        select, input[type=range] { width: 100%; }
        
        .btn-action { border: none; height: 42px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; background: #F2F2F7; color: #1C1C1E; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: white; }
        
        .tools-row { display: flex; gap: 8px; }
        .tool-btn { flex: 1; padding: 10px; border: 1px solid #E5E5EA; border-radius: 8px; background: white; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .color-palette { display: flex; gap: 10px; justify-content: space-between; }
        .color-swatch { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.active { border-color: #000; transform: scale(1.1); }

        footer {
            height: var(--footer-h); flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: #888;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0,0,0,0.05); z-index: 1100;
        }

        @media (max-width: 900px) {
            .sidebar { position: fixed; left: 0; top: 60px; bottom: 50px; width: 85%; max-width: 320px; }
            .top-menu { display: none; }
            .header-container { justify-content: center; }
            .toggle-btn { right: 10px; top: 10px; border-radius: 50%; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-container">
            <a href="index.html" class="logo" id="logoLink">–°–∞–π—Ç –ø—Ä–æ–ø–∏—Å–µ–π</a>
            <nav class="top-menu">
                <a href="board.html" style="color:var(--ink);">–î–æ—Å–∫–∞</a>
                <a href="generator.html">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</a>
                <a href="propisi-alfavit.html">–ê–ª—Ñ–∞–≤–∏—Ç</a>
                <a href="about.html">–û –Ω–∞—Å</a>
            </nav>
        </div>
    </header>

    <div class="app-body">
        <div class="sidebar" id="appSidebar">
            <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
            
            <div class="section">
                <div class="section-label">1. –ü–æ–¥–ª–æ–∂–∫–∞</div>
                <select id="bgSelect" onchange="changeBackground()">
                    <option value="propisi_often" selected>–£–∑–∫–∞—è –∫–æ—Å–∞—è (1 –∫–ª–∞—Å—Å)</option>
                    <option value="mazina">–°–µ—Ç–∫–∞ –ú–∞–∑–∏–Ω–æ–π (–†–∏—Ç–º)</option>
                    <option value="propisi_lines">–£–∑–∫–∞—è –ª–∏–Ω–µ–π–∫–∞ (2 –∫–ª–∞—Å—Å)</option>
                    <option value="wide_lines">–®–∏—Ä–æ–∫–∞—è –ª–∏–Ω–µ–π–∫–∞</option>
                    <option value="cell">–ö–ª–µ—Ç–∫–∞ (5 –º–º)</option> 
                    <option value="white">–ß–∏—Å—Ç—ã–π –ª–∏—Å—Ç</option>
                    <option value="custom">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—ë —Ñ–æ—Ç–æ...</option>
                </select>
                <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleImageUpload()">
            </div>

            <div class="section">
                <div class="section-label">2. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
                <div class="tools-row">
                    <button class="tool-btn active" onclick="setTool('pen')" id="btnPen">üñä –†—É—á–∫–∞</button>
                    <button class="tool-btn" onclick="setTool('eraser')" id="btnEraser">üßº –õ–∞—Å—Ç–∏–∫</button>
                    <button class="tool-btn" onclick="undo()">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞</button>
                </div>
                <div class="color-palette">
                    <div class="color-swatch active" style="background: #0055AA" onclick="setColor('#0055AA', this)"></div>
                    <div class="color-swatch" style="background: #FF3B30" onclick="setColor('#FF3B30', this)"></div>
                    <div class="color-swatch" style="background: #34C759" onclick="setColor('#34C759', this)"></div>
                    <div class="color-swatch" style="background: #000000" onclick="setColor('#000000', this)"></div>
                </div>
                <div class="section-label" style="font-size: 10px;">–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏</div>
                <input type="range" id="lineWidth" min="1" max="15" value="4">
            </div>

            <div class="section">
                <div class="section-label">3. –ó–∞–ø–∏—Å—å —É—Ä–æ–∫–∞</div>
                <button class="btn-action btn-primary" id="btnPlay" onclick="playRecording(false)">‚ñ∂Ô∏è –ü—Ä–æ–∏–≥—Ä–∞—Ç—å</button>
                <div class="tools-row" style="margin-top:5px;">
                    <button class="btn-action" style="flex:1;" onclick="playRecording(true)">üìπ –í–∏–¥–µ–æ</button>
                    <button class="btn-action" style="flex:1;" onclick="downloadImage()">üì∑ –§–æ—Ç–æ</button>
                </div>
                <div style="margin-top:5px;">
                    <div class="section-label" style="font-size: 10px;">–°–∫–æ—Ä–æ—Å—Ç—å</div>
                    <input type="range" id="speedRange" min="1" max="10" value="5">
                </div>
            </div>

            <div class="section" style="margin-top:auto;">
                <button class="btn-action" onclick="clearCanvas()" style="color:#FF3B30;">üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            </div>
        </div>

        <div class="main-area">
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="bgCanvas" width="2480" height="3508"></canvas>
                <canvas id="drawCanvas" width="2480" height="3508"></canvas>
            </div>
        </div>
    </div>

    <footer>
        <p>–°–∞–π—Ç –ø—Ä–æ–ø–∏—Å–µ–π (propisi.site) ‚Äî —Å–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –∫ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é ¬© 2026.</p>
    </footer>

    <script>
        // –î–í–ò–ñ–û–ö PRIMO
        function getHeadAndTail(char){const code=char.charCodeAt(0);const map={0x0410:{h:100,t:8},0x0411:{h:100,t:100},0x0412:{h:100,t:100},0x0413:{h:100,t:100},0x0414:{h:100,t:8},0x0415:{h:100,t:4},0x0416:{h:100,t:4},0x0417:{h:100,t:100},0x0418:{h:100,t:1},0x0419:{h:100,t:1},0x041A:{h:100,t:1},0x041B:{h:100,t:1},0x041C:{h:100,t:1},0x041D:{h:100,t:1},0x041E:{h:100,t:100},0x041F:{h:100,t:1},0x0420:{h:100,t:100},0x0421:{h:100,t:4},0x0422:{h:100,t:1},0x0423:{h:100,t:100},0x0424:{h:100,t:100},0x0425:{h:100,t:4},0x0426:{h:100,t:6},0x0427:{h:100,t:1},0x0428:{h:100,t:1},0x0429:{h:100,t:6},0x042A:{h:100,t:100},0x042B:{h:100,t:1},0x042C:{h:100,t:100},0x042D:{h:100,t:100},0x042E:{h:100,t:100},0x042F:{h:100,t:1},0x0401:{h:100,t:4},0x0430:{h:2,t:1},0x0431:{h:2,t:100},0x0432:{h:6,t:2},0x0433:{h:7,t:1},0x0434:{h:2,t:3},0x0435:{h:5,t:4},0x0436:{h:4,t:4},0x0437:{h:4,t:3},0x0438:{h:1,t:1},0x0439:{h:1,t:1},0x043A:{h:1,t:1},0x043B:{h:3,t:1},0x043C:{h:3,t:1},0x043D:{h:1,t:1},0x043E:{h:2,t:5},0x043F:{h:1,t:1},0x0440:{h:1,t:1},0x0441:{h:2,t:4},0x0442:{h:1,t:1},0x0443:{h:1,t:3},0x0444:{h:2,t:100},0x0445:{h:4,t:4},0x0446:{h:1,t:6},0x0447:{h:8,t:1},0x0448:{h:1,t:1},0x0449:{h:1,t:6},0x044A:{h:8,t:7},0x044B:{h:1,t:1},0x044C:{h:1,t:7},0x044D:{h:4,t:100},0x044E:{h:1,t:5},0x044F:{h:3,t:1},0x0451:{h:5,t:4}};if(map[code])return map[code];if(code>=0xE000)return{h:200,t:200};return{h:0,t:0}}function ins(c1,c2){if(!c1||!c2)return"";const i1=getHeadAndTail(c1),i2=getHeadAndTail(c2);const t=i1.t,h=i2.h;if(t===0){if(h===1||h===2||h===3||h===100)return"\uE402";if(h===4)return"\uE402\uE007";if(h===5)return"\uE402\uE005";if(h===6)return"\uE402\uE006";if(h===7)return"\uE402\uE007";if(h===8)return"\uE402\uE008"}if(t===100){if(h===1)return"\uE402\uE402";if(h===2)return"\uE402\uE401";if(h===100)return"\uE403"}return""}function processPrimoText(text){if(!text)return"";let res="",c1="",c2=text[0];res+=ins(" ",c2)+c2;for(let i=1;i<text.length;i++){c1=c2;c2=text[i];res+=ins(c1,c2)+c2}res+=ins(c2," ");return res}

        const bgC = document.getElementById('bgCanvas'), bgCtx = bgC.getContext('2d');
        const drawC = document.getElementById('drawCanvas'), drawCtx = drawC.getContext('2d');
        const wrap = document.getElementById('canvasWrapper');

        let actions = [], currentStroke = null, isDrawing = false, isReplaying = false;
        let tool = 'pen', color = '#0055AA', zoom = 0.3, customImage = null;
        const MM = 11.81, ROW_H = 4 * MM, GAP_H = 8 * MM, MT = 20 * MM;

        window.onload = () => {
            document.getElementById('logoLink').innerText = processPrimoText("–°–∞–π—Ç –ø—Ä–æ–ø–∏—Å–µ–π");
            setAdaptiveZoom(); drawBackground();
        };
        window.onresize = setAdaptiveZoom;

        function toggleSidebar() { sidebar.classList.toggle('closed'); }
        function setAdaptiveZoom() { zoom = (window.innerWidth - (window.innerWidth > 900 ? 360 : 0)) * 0.9 / 2480; wrap.style.transform = `scale(${zoom})`; }

        function changeBackground() {
            const v = document.getElementById('bgSelect').value;
            if (v === 'custom') document.getElementById('fileInput').click();
            else { customImage = null; drawBackground(); }
        }

        function handleImageUpload() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { customImage = new Image(); customImage.onload = drawBackground; customImage.src = e.target.result; };
                reader.readAsDataURL(file);
            }
        }

        // –û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –°–ï–¢–û–ö v11.5
        function drawBackground() {
            const w = bgC.width, h = bgC.height, type = document.getElementById('bgSelect').value;
            bgCtx.fillStyle = 'white'; bgCtx.fillRect(0,0,w,h);
            if(customImage) { bgCtx.drawImage(customImage,0,0,w,h); return; }
            if(type === 'white') return;
            bgCtx.beginPath(); bgCtx.strokeStyle = '#FF8080'; bgCtx.lineWidth = 4;
            bgCtx.moveTo(20*MM, 0); bgCtx.lineTo(20*MM, h); bgCtx.stroke();
            if (type === 'cell') {
                bgCtx.lineWidth = 1; bgCtx.strokeStyle = '#5096F2';
                for(let x=0; x<w; x+=5*MM){ bgCtx.beginPath(); bgCtx.moveTo(x,0); bgCtx.lineTo(x,h); bgCtx.stroke(); }
                for(let y=0; y<h; y+=5*MM){ bgCtx.beginPath(); bgCtx.moveTo(0,y); bgCtx.lineTo(w,y); bgCtx.stroke(); }
            } else if (type === 'wide_lines') {
                bgCtx.lineWidth = 2; bgCtx.strokeStyle = '#5096F2';
                for(let y=MT; y<h; y+=9*MM){ bgCtx.beginPath(); bgCtx.moveTo(0,y); bgCtx.lineTo(w,y); bgCtx.stroke(); }
            } else {
                let y = MT;
                while(y < h-MT) {
                    bgCtx.lineWidth = 2; bgCtx.strokeStyle = '#5096F2'; bgCtx.setLineDash([]);
                    bgCtx.beginPath(); bgCtx.moveTo(0,y); bgCtx.lineTo(w,y); bgCtx.stroke();
                    bgCtx.beginPath(); bgCtx.moveTo(0,y+ROW_H); bgCtx.lineTo(w,y+ROW_H); bgCtx.stroke();
                    if(type === 'mazina') {
                        bgCtx.setLineDash([5,5]); bgCtx.lineWidth = 1;
                        bgCtx.beginPath(); bgCtx.moveTo(0, y+ROW_H/2); bgCtx.lineTo(w, y+ROW_H/2); bgCtx.stroke();
                        bgCtx.beginPath(); bgCtx.moveTo(0, y+ROW_H+GAP_H/2); bgCtx.lineTo(w, y+ROW_H+GAP_H/2); bgCtx.stroke();
                    }
                    y += (ROW_H + GAP_H);
                }
                bgCtx.setLineDash([]); bgCtx.strokeStyle = '#D1D1D6';
                let step = type === 'mazina' ? 3.5*MM : 25*MM;
                for(let x = -h*0.466; x < w; x += step) {
                    bgCtx.beginPath(); bgCtx.moveTo(x+h*0.466, 0); bgCtx.lineTo(x, h); bgCtx.stroke();
                }
            }
        }

        // –û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ò–°–û–í–ê–ù–ò–Ø v11.5
        function getCoords(e) {
            const rect = drawC.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) / zoom, y: (clientY - rect.top) / zoom };
        }
        function startDraw(e) {
            if(isReplaying) return; isDrawing = true;
            const c = getCoords(e);
            currentStroke = { tool, color, width: document.getElementById('lineWidth').value * 2, points: [c] };
            setupStyle(currentStroke); drawCtx.beginPath(); drawCtx.moveTo(c.x, c.y);
        }
        function moveDraw(e) {
            if(!isDrawing) return; e.preventDefault();
            const c = getCoords(e); currentStroke.points.push(c);
            drawCtx.lineTo(c.x, c.y); drawCtx.stroke();
        }
        function endDraw() { if(isDrawing) actions.push(currentStroke); isDrawing = false; }

        drawC.addEventListener('mousedown', startDraw); drawC.addEventListener('mousemove', moveDraw);
        drawC.addEventListener('mouseup', endDraw); drawC.addEventListener('touchstart', startDraw, {passive:false});
        drawC.addEventListener('touchmove', moveDraw, {passive:false}); drawC.addEventListener('touchend', endDraw);

        function setupStyle(s) {
            drawCtx.lineCap = 'round'; drawCtx.lineJoin = 'round'; drawCtx.lineWidth = s.width;
            if(s.tool === 'eraser') { drawCtx.globalCompositeOperation = 'destination-out'; drawCtx.lineWidth = 60; }
            else { drawCtx.globalCompositeOperation = 'source-over'; drawCtx.strokeStyle = s.color; }
        }
        function setTool(t) { tool = t; document.getElementById('btnPen').classList.toggle('active', t==='pen'); document.getElementById('btnEraser').classList.toggle('active', t==='eraser'); }
        function setColor(c, el) { color = c; setTool('pen'); document.querySelectorAll('.color-swatch').forEach(d => d.classList.remove('active')); el.classList.add('active'); }
        function undo() { actions.pop(); redraw(); }
        function clearCanvas() { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å?')) { actions = []; redraw(); } }
        function redraw() { drawCtx.clearRect(0,0,drawC.width,drawC.height); actions.forEach(s => { drawCtx.beginPath(); setupStyle(s); drawCtx.moveTo(s.points[0].x, s.points[0].y); s.points.forEach(p => drawCtx.lineTo(p.x, p.y)); drawCtx.stroke(); }); }

        function downloadImage() {
            const temp = document.createElement('canvas'); temp.width = 2480; temp.height = 3508;
            const tCtx = temp.getContext('2d'); tCtx.drawImage(bgC,0,0); tCtx.drawImage(drawC,0,0);
            const link = document.createElement('a'); link.download = 'board.jpg'; link.href = temp.toDataURL('image/jpeg', 0.9); link.click();
        }

        function playRecording(exp) {
            if(!actions.length) return; isReplaying = true;
            let recorder = null, chunks = [];
            if(exp) {
                const stream = drawC.captureStream(30); recorder = new MediaRecorder(stream, {mimeType:'video/webm'});
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(chunks, {type:'video/webm'})); a.download = 'lesson.webm'; a.click(); redraw(); };
                recorder.start();
            }
            drawCtx.clearRect(0,0,drawC.width,drawC.height);
            let aI = 0, pI = 0, speed = parseInt(document.getElementById('speedRange').value);
            function animate() {
                if(!isReplaying) return;
                if(exp) drawCtx.drawImage(bgC, 0, 0);
                for(let i=0; i<speed*2; i++) {
                    const s = actions[aI];
                    if(!pI) { drawCtx.beginPath(); setupStyle(s); drawCtx.moveTo(s.points[0].x, s.points[0].y); pI = 1; }
                    drawCtx.lineTo(s.points[pI].x, s.points[pI].y); drawCtx.stroke(); pI++;
                    if(pI >= s.points.length) { aI++; pI = 0; if(aI >= actions.length) { isReplaying = false; if(recorder) recorder.stop(); return; } }
                }
                requestAnimationFrame(animate);
            }
            animate();
        }
    </script>
</body>
</html>
