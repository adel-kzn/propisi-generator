<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –ü—Ä–æ–ø–∏—Å–∏ –û–Ω–ª–∞–π–Ω | –î–æ—Å–∫–∞ –¥–ª—è –£—á–∏—Ç–µ–ª—è</title>

    <meta name="description" content="–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ—Å–∫–∞ –¥–ª—è —É—Ä–æ–∫–æ–≤ —á–∏—Å—Ç–æ–ø–∏—Å–∞–Ω–∏—è. –†–∏—Å—É–π—Ç–µ –≤ —É–∑–∫—É—é –∫–æ—Å—É—é, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Ç–∫—É –ú–∞–∑–∏–Ω–æ–π, –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –≤–∏–¥–µ–æ-—É—Ä–æ–∫–∏ –ø–∏—Å—å–º–∞.">
    <meta name="keywords" content="–ø—Ä–æ–ø–∏—Å–∏ –æ–Ω–ª–∞–π–Ω, –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ—Å–∫–∞, —á–∏—Å—Ç–æ–ø–∏—Å–∞–Ω–∏–µ, —É–∑–∫–∞—è –∫–æ—Å–∞—è, —Å–µ—Ç–∫–∞ –º–∞–∑–∏–Ω–æ–π, —É—Ä–æ–∫–∏ –ø–∏—Å—å–º–∞">
    <meta name="author" content="Propisi.site">

    <meta property="og:type" content="website">
    <meta property="og:title" content="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –ü—Ä–æ–ø–∏—Å–∏: –û–Ω–ª–∞–π–Ω –î–æ—Å–∫–∞ –¥–ª—è –£—á–∏—Ç–µ–ª—è">
    <meta property="og:description" content="–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –≤–∏–¥–µ–æ-—É—Ä–æ–∫–∏ –ø–∏—Å—å–º–∞, —Ä–∏—Å—É–π—Ç–µ –Ω–∞ —Å–µ—Ç–∫–µ '—É–∑–∫–∞—è –∫–æ—Å–∞—è' –∏ –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ —É—á–µ–Ω–∏–∫–∞–º. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ.">
    <meta property="og:url" content="https://propisi.site/">
    <meta property="og:image" content="https://propisi.site/preview.jpg">

   <link rel="icon" type="image/png" href="/favicon.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicon.png"> 


    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
       ym(106467293, "init", {clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/106467293" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

    <style>
        :root { --app-bg: #Eef2F5; --sidebar-bg: #FFFFFF; --text-primary: #1C1C1E; --text-secondary: #8E8E93; --accent: #007AFF; --radius-M: 10px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--app-bg); color: var(--text-primary); height: 100vh; display: flex; overflow: hidden; }

        .toggle-btn { position: fixed; top: 15px; left: 15px; width: 44px; height: 44px; background: white; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; font-size: 24px; border: none; cursor: pointer; z-index: 2000; color: var(--accent); transition: transform 0.2s; }
        .toggle-btn:active { transform: scale(0.9); }

        .sidebar { width: 360px; min-width: 360px; height: 100%; background: var(--sidebar-bg); border-right: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; padding: 20px; padding-top: 70px; gap: 15px; overflow-y: auto; z-index: 1000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .sidebar.closed { transform: translateX(-100%); position: absolute; }

        .app-title { font-size: 20px; font-weight: 700; margin: 0; }
        .app-subtitle { font-size: 12px; color: var(--text-secondary); margin: 0; }
        
        .nav-tabs { display: flex; background: #F2F2F7; padding: 4px; border-radius: 10px; }
        .nav-tab { flex: 1; text-align: center; padding: 8px 12px; font-size: 13px; font-weight: 500; text-decoration: none; color: var(--text-primary); border-radius: 7px; transition: all 0.2s; }
        .nav-tab.active { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .section { display: flex; flex-direction: column; gap: 8px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .section-label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); }

        select, input[type=file] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #E5E5EA; background-color: white; font-size: 14px; outline: none; }

        .tools-row { display: flex; gap: 8px; }
        .tool-btn { flex: 1; padding: 10px; border: 1px solid #E5E5EA; border-radius: 8px; background: white; cursor: pointer; text-align: center; font-size: 13px; font-weight: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .color-palette { display: flex; gap: 10px; justify-content: space-between; }
        .color-swatch { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .color-swatch.active { border-color: #000; transform: scale(1.1); }

        .control-row { display: flex; align-items: center; gap: 10px; background: #F2F2F7; padding: 5px; border-radius: 8px; }
        .zoom-btn { width: 36px; height: 36px; border: none; background: white; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; color: var(--accent); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .val-display { flex-grow: 1; text-align: center; font-size: 14px; font-weight: 600; color: var(--text-primary); }
        input[type=range] { width: 100%; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button.btn-action { border: none; height: 40px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; background: #F2F2F7; color: var(--text-primary); transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 100%; }
        button.btn-action:hover { background: #E5E5EA; }
        button.btn-primary { background: var(--accent); color: white; }
        button.btn-danger { background: #FF3B30; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .sidebar-footer { font-size: 11px; color: #999; margin-top: 5px; line-height: 1.4; text-align: center; padding-top: 10px; border-top: 1px solid #f0f0f0; }
        .sidebar-footer a { color: #999; text-decoration: underline; }
        
        .main-area { flex-grow: 1; background-color: var(--app-bg); display: flex; align-items: center; justify-content: center; overflow: auto; position: relative; width: 100%; }
        .canvas-wrapper { background: white; box-shadow: 0 4px 30px rgba(0,0,0,0.15); position: relative; flex-shrink: 0; margin: auto; }
        canvas { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        #bgCanvas { z-index: 1; }
        #drawCanvas { z-index: 2; cursor: crosshair; }

        @media (max-width: 900px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 85%; max-width: 320px; box-shadow: 4px 0 20px rgba(0,0,0,0.2); }
            .sidebar.closed { transform: translateX(-100%); }
            .main-area { padding: 10px; padding-top: 60px; display: block; overflow: scroll; }
            .canvas-wrapper { margin: 0 auto; }
        }
    </style>
</head>
<body>

    <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="sidebar" id="appSidebar">
        <div class="app-header">
            <h1 class="app-title">–ü—Ä–æ–ø–∏—Å–∏</h1>
            <p class="app-subtitle">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ—Å–∫–∞ v11.5</p>
        </div>

        <div class="nav-tabs">
            <a href="index.html" class="nav-tab active">–†–∏—Å–æ–≤–∞–Ω–∏–µ</a>
            <a href="generator.html" class="nav-tab">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</a>
        </div>

        <div class="section">
            <div class="section-label">1. –ü–æ–¥–ª–æ–∂–∫–∞</div>
            <select id="bgSelect" onchange="changeBackground()">
                <option value="propisi_often" selected>–£–∑–∫–∞—è –∫–æ—Å–∞—è (1 –∫–ª–∞—Å—Å)</option>
                <option value="mazina">–°–µ—Ç–∫–∞ –ú–∞–∑–∏–Ω–æ–π (–†–∏—Ç–º)</option>
                <option value="propisi_lines">–£–∑–∫–∞—è –ª–∏–Ω–µ–π–∫–∞ (2 –∫–ª–∞—Å—Å)</option>
                <option value="wide_lines">–®–∏—Ä–æ–∫–∞—è –ª–∏–Ω–µ–π–∫–∞ (–°—Ç–∞—Ä—à–∏–µ)</option>
                <option value="cell">–ö–ª–µ—Ç–∫–∞ (5 –º–º)</option> 
                <option value="white">–ß–∏—Å—Ç—ã–π –ª–∏—Å—Ç</option>
                <option value="custom">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—ë —Ñ–æ—Ç–æ...</option>
            </select>
            
            <button id="btnUploadBg" class="btn-action" style="display:none; margin-top:8px; background:#E5E5EA;" onclick="document.getElementById('fileInput').click()">
                üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
            </button>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleImageUpload()">
        </div>

        <div class="section">
            <div class="section-label">2. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
            <div class="tools-row">
                <div class="tool-btn active" onclick="setTool('pen')" id="btnPen">üñä –†—É—á–∫–∞</div>
                <div class="tool-btn" onclick="setTool('eraser')" id="btnEraser">üßº –õ–∞—Å—Ç–∏–∫</div>
                <div class="tool-btn" onclick="undo()" title="–û—Ç–º–µ–Ω–∏—Ç—å">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞</div>
            </div>
            
            <div class="color-palette" id="palette">
                <div class="color-swatch active" style="background:#0055AA" onclick="setColor('#0055AA', this)"></div>
                <div class="color-swatch" style="background:#FF3B30" onclick="setColor('#FF3B30', this)"></div>
                <div class="color-swatch" style="background:#34C759" onclick="setColor('#34C759', this)"></div>
                <div class="color-swatch" style="background:#000000" onclick="setColor('#000000', this)"></div>
            </div>
            
            <div style="margin-top:5px;">
                <div class="section-label">–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏</div>
                <input type="range" id="lineWidth" min="1" max="15" value="4">
            </div>
        </div>

        <div class="section">
            <div class="section-label">3. –ó–∞–ø–∏—Å—å —É—Ä–æ–∫–∞</div>
            <button class="btn-action btn-primary" id="btnPlay" onclick="playRecording(false)">‚ñ∂Ô∏è –ü—Ä–æ–∏–≥—Ä–∞—Ç—å (–ö–∞–∫ —É—á–∏—Ç–µ–ª—å)</button>
            
            <div style="margin-top:5px;">
                <div class="section-label">–°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è</div>
                <div class="control-row">
                    <span style="font-size:12px; color:#888;">0.5x</span>
                    <input type="range" id="speedRange" min="1" max="10" value="5" oninput="updateSpeedDisp()">
                    <span style="font-size:12px; color:#888;">3x</span>
                </div>
                <div style="text-align:center; font-size:12px; color:#555; margin-top:2px;" id="speedVal">1.0x</div>
            </div>

            <div class="action-grid" style="margin-top:8px;">
                 <button class="btn-action" id="btnExport" onclick="playRecording(true)">üìπ –ó–∞–ø–∏—Å–∞—Ç—å –í–∏–¥–µ–æ</button>
                 <button class="btn-action" onclick="downloadImage()">üì∑ –°–∫–∞—á–∞—Ç—å –§–æ—Ç–æ</button>
            </div>
        </div>

        <div class="section" style="margin-top:auto; border-top: 1px solid #f0f0f0; padding-top: 10px;">
            <div class="control-row">
                <button class="zoom-btn" onclick="changeZoom(-0.1)">‚àí</button>
                <div class="val-display" id="zoomVal">100%</div>
                <button class="zoom-btn" onclick="changeZoom(0.1)">+</button>
            </div>
            <button class="btn-action btn-danger" style="margin-top:10px; margin-bottom:15px;" onclick="clearCanvas()">üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>

            <div style="display: flex; flex-direction: column; gap: 6px; padding-top: 5px;">
                <div class="section-label">üìö –ü–æ–ª–µ–∑–Ω–æ–µ</div>
                <a href="shablon-uzkaya-kosaya.html" style="font-size: 13px; text-decoration: none; color: #007AFF;">üìÑ –®–∞–±–ª–æ–Ω: –£–∑–∫–∞—è –∫–æ—Å–∞—è</a>
                <a href="propisi-alfavit.html" style="font-size: 13px; text-decoration: none; color: #007AFF;">üî§ –í–µ—Å—å –ê–ª—Ñ–∞–≤–∏—Ç (–ê-–Ø)</a>
            </div>
        </div>

        <div class="sidebar-footer">
            <a href="about.html">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</a> | <a href="propisi-alfavit.html">–ê–ª—Ñ–∞–≤–∏—Ç</a><br>
            <span style="font-size:10px; color:#ccc;">¬© 2026 Propisi.site</span>
        </div>
    </div>

    <div class="main-area">
        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="bgCanvas" width="2480" height="3508"></canvas>
            <canvas id="drawCanvas" width="2480" height="3508"></canvas>
        </div>
    </div>

    <script>
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        const drawCanvas = document.getElementById('drawCanvas');
        const drawCtx = drawCanvas.getContext('2d');
        const wrapper = document.getElementById('canvasWrapper');
        const sidebar = document.getElementById('appSidebar');

        let actions = []; 
        let currentStroke = null;
        let isDrawing = false;
        let isReplaying = false;
        let tool = 'pen';
        let color = '#0055AA';
        let zoom = 1.0;
        let customImage = null; 
        let playbackSpeed = 5;

        const MM = 11.81;
        const ROW_H = 4 * MM; 
        const GAP_H = 8 * MM; 
        const MT = 20 * MM; 
        const BASE_WIDTH_PX = 794; 
        const BASE_HEIGHT_PX = 1123;

        window.onload = function() {
            setZoom(1.0);
            updateSpeedDisp();
            drawBackground();
            setupEvents();
        };

        function toggleSidebar() { sidebar.classList.toggle('closed'); }

        function updateSpeedDisp() {
            playbackSpeed = parseInt(document.getElementById('speedRange').value);
            let factor = 1.0;
            if (playbackSpeed < 5) factor = 0.5 + (playbackSpeed-1)*0.125;
            else factor = 1.0 + (playbackSpeed-5)*0.4;
            document.getElementById('speedVal').innerText = factor.toFixed(1) + 'x';
        }

        function changeBackground() {
            const val = document.getElementById('bgSelect').value;
            const btn = document.getElementById('btnUploadBg');
            if (val === 'custom') {
                btn.style.display = 'flex'; 
                document.getElementById('fileInput').click(); 
            } else {
                btn.style.display = 'none'; 
                customImage = null;
                drawBackground();
            }
        }

        function handleImageUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() { customImage = img; drawBackground(); };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                fileInput.value = '';
            }
        }

        function drawBackground() {
            const w = bgCanvas.width;
            const h = bgCanvas.height;
            const type = document.getElementById('bgSelect').value;
            
            // –û—á–∏—Å—Ç–∫–∞
            bgCtx.fillStyle = 'white';
            bgCtx.fillRect(0, 0, w, h);

            if (customImage) { bgCtx.drawImage(customImage, 0, 0, w, h); return; }
            if (type === 'white') return;

            // –ü–û–õ–Ø
            bgCtx.save();
            bgCtx.lineWidth = 2;
            bgCtx.setLineDash([]);
            bgCtx.beginPath(); bgCtx.strokeStyle = '#FF8080'; bgCtx.lineWidth = 4;
            bgCtx.moveTo(20*MM, 0); bgCtx.lineTo(20*MM, h); bgCtx.stroke();
            bgCtx.restore();
            
            // –ö–õ–ï–¢–ö–ê
            if (type === 'cell') {
                const cellSize = 5 * MM; 
                bgCtx.lineWidth = 1; bgCtx.strokeStyle = '#5096F2'; 
                bgCtx.beginPath();
                for (let x = 0; x < w; x += cellSize) { bgCtx.moveTo(x, 0); bgCtx.lineTo(x, h); }
                for (let y = 0; y < h; y += cellSize) { bgCtx.moveTo(0, y); bgCtx.lineTo(w, y); }
                bgCtx.stroke();
                
                // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª–µ —Å–≤–µ—Ä—Ö—É
                bgCtx.beginPath(); bgCtx.strokeStyle = '#FF8080'; bgCtx.lineWidth = 4;
                bgCtx.moveTo(20*MM, 0); bgCtx.lineTo(20*MM, h); bgCtx.stroke();
                return;
            }

            // –®–ò–†–û–ö–ê–Ø –õ–ò–ù–ï–ô–ö–ê
            if (type === 'wide_lines') {
                const lineStep = 9 * MM; 
                bgCtx.lineWidth = 2; bgCtx.strokeStyle = '#5096F2';
                bgCtx.beginPath();
                for (let y = MT; y < h; y += lineStep) {
                    bgCtx.moveTo(0, y); bgCtx.lineTo(w, y);
                }
                bgCtx.stroke();
                return;
            }

            // --- –û–ë–´–ß–ù–´–ï / –ß–ê–°–¢–´–ï / –ú–ê–ó–ò–ù–ê ---
            let lineHeight = ROW_H; 
            const totalH = lineHeight + GAP_H;
            let y = MT;
            
            let drawSlant = false;
            let slantStep = 0;
            
            if (type === 'propisi_often') { drawSlant = true; slantStep = 25 * MM; }
            if (type === 'mazina') { drawSlant = true; slantStep = 3.5 * MM; } 

            // –†–∏—Å—É–µ–º —Å—Ç—Ä–æ–∫–∏
            while(y < h - MT) {
                // –û—Å–Ω–æ–≤–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏
                bgCtx.lineWidth = 2; bgCtx.strokeStyle = '#5096F2'; bgCtx.setLineDash([]);
                bgCtx.beginPath(); 
                bgCtx.moveTo(0, y); bgCtx.lineTo(w, y); 
                bgCtx.stroke();
                
                bgCtx.beginPath(); 
                bgCtx.moveTo(0, y + lineHeight); bgCtx.lineTo(w, y + lineHeight); 
                bgCtx.stroke();

                // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –õ–ò–ù–ò–ò –î–õ–Ø –ú–ê–ó–ò–ù–û–ô
                if (type === 'mazina') {
                    // 1. –ü—É–Ω–∫—Ç–∏—Ä –≤ –º–µ–∂—Å—Ç—Ä–æ—á–Ω–æ–º (—Å–µ—Ä–µ–¥–∏–Ω–∞ GAP)
                    const midGap = y + lineHeight + (GAP_H / 2); 
                    bgCtx.lineWidth = 1; bgCtx.strokeStyle = '#5096F2';
                    bgCtx.setLineDash([5, 5]); 
                    bgCtx.beginPath();
                    bgCtx.moveTo(0, midGap); bgCtx.lineTo(w, midGap);
                    bgCtx.stroke();

                    // 2. –ü—É–Ω–∫—Ç–∏—Ä –≤–Ω—É—Ç—Ä–∏ —Ä–∞–±–æ—á–µ–π —Å—Ç—Ä–æ–∫–∏ (—Å–µ—Ä–µ–¥–∏–Ω–∞ ROW)
                    const midRow = y + (lineHeight / 2);
                    bgCtx.beginPath();
                    bgCtx.moveTo(0, midRow); bgCtx.lineTo(w, midRow);
                    bgCtx.stroke();

                    bgCtx.setLineDash([]); 
                }

                y += totalH;
            }
            
            // –ö–æ—Å—ã–µ –ª–∏–Ω–∏–∏ (—Ä–∏—Å—É–µ–º –ü–û–°–õ–ï –≤—Å–µ–≥–æ)
            if (drawSlant) {
                bgCtx.save();
                bgCtx.lineWidth = (type === 'mazina') ? 1 : 2; 
                bgCtx.strokeStyle = (type === 'mazina') ? '#BBBBBB' : '#D1D1D6'; 
                bgCtx.beginPath(); 
                
                const tan = 0.466; 
                const shift = h * tan;
                
                // –†–∏—Å—É–µ–º —Å –∑–∞–ø–∞—Å–æ–º —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞
                for(let x = -shift; x < w; x += slantStep) {
                    bgCtx.moveTo(x + shift, 0); 
                    bgCtx.lineTo(x, h);
                }
                bgCtx.stroke();
                bgCtx.restore();
            }
        }

        // --- –õ–û–ì–ò–ö–ê –†–ò–°–û–í–ê–ù–ò–Ø ---
        function getCoords(e) {
            const rect = drawCanvas.getBoundingClientRect();
            let clientX = e.clientX; let clientY = e.clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX; clientY = e.touches[0].clientY;
            }
            const x = clientX - rect.left; const y = clientY - rect.top;
            return { x: x * (drawCanvas.width / rect.width), y: y * (drawCanvas.height / rect.height) };
        }

        function startDraw(e) {
            if (isReplaying) return;
            isDrawing = true;
            const coords = getCoords(e);
            const width = document.getElementById('lineWidth').value * 2;
            currentStroke = {
                type: 'stroke', tool: tool, color: color, width: width, points: [ {x: coords.x, y: coords.y} ]
            };
            drawCtx.beginPath();
            drawCtx.lineCap = 'round'; drawCtx.lineJoin = 'round';
            drawCtx.lineWidth = width;
            drawCtx.strokeStyle = (tool === 'eraser') ? 'rgba(0,0,0,1)' : color;
            drawCtx.globalCompositeOperation = (tool === 'eraser') ? 'destination-out' : 'source-over';
            if (tool === 'eraser') drawCtx.lineWidth = 60; 
            drawCtx.moveTo(coords.x, coords.y);
        }

        function moveDraw(e) {
            if (!isDrawing) return;
            e.preventDefault(); 
            const coords = getCoords(e);
            currentStroke.points.push({x: coords.x, y: coords.y});
            drawCtx.lineTo(coords.x, coords.y);
            drawCtx.stroke();
        }

        function endDraw() {
            if (isDrawing && currentStroke) actions.push(currentStroke);
            isDrawing = false;
            currentStroke = null;
            drawCtx.beginPath();
        }

        function setupEvents() {
            drawCanvas.addEventListener('mousedown', startDraw);
            drawCanvas.addEventListener('mousemove', moveDraw);
            drawCanvas.addEventListener('mouseup', endDraw);
            drawCanvas.addEventListener('mouseout', endDraw);
            drawCanvas.addEventListener('touchstart', startDraw, {passive: false});
            drawCanvas.addEventListener('touchmove', moveDraw, {passive: false});
            drawCanvas.addEventListener('touchend', endDraw);
        }

        // --- UI ---
        function setTool(t) {
            tool = t;
            document.getElementById('btnPen').classList.toggle('active', t==='pen');
            document.getElementById('btnEraser').classList.toggle('active', t==='eraser');
        }
        function setColor(c, el) {
            color = c; tool = 'pen'; setTool('pen');
            document.querySelectorAll('.color-swatch').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }
        function changeZoom(delta) {
            let newZoom = Math.round((zoom + delta) * 10) / 10;
            if (newZoom < 0.2) newZoom = 0.2; if (newZoom > 5.0) newZoom = 5.0;
            setZoom(newZoom);
        }
        function setZoom(z) {
            zoom = z;
            document.getElementById('zoomVal').innerText = Math.round(zoom * 100) + '%';
            wrapper.style.width = (BASE_WIDTH_PX * zoom) + 'px';
            wrapper.style.height = (BASE_HEIGHT_PX * zoom) + 'px';
        }
        function undo() {
            if (actions.length === 0 || isReplaying) return;
            actions.pop();
            redrawAll();
        }
        function clearCanvas() {
            if (isReplaying) return;
            if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏?')) {
                actions = [];
                drawCtx.clearRect(0,0, drawCanvas.width, drawCanvas.height);
            }
        }

        // --- PLAY & EXPORT ---
        function playRecording(forExport) {
            if (actions.length === 0) { alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!'); return; }
            if (isReplaying) return;

            isReplaying = true;
            toggleButtons(false); 

            let recorder = null;
            
            if (forExport) {
                const stream = drawCanvas.captureStream(30);
                recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'lesson.webm';
                    a.click();
                    redrawAll(); 
                };
                recorder.start();
                alert("–ó–∞–ø–∏—Å—å –ø–æ—à–ª–∞! –ù–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ –≤–∫–ª–∞–¥–∫—É.");
            }

            drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
            
            let actionIdx = 0;
            let pointIdx = 0;
            const speed = parseInt(document.getElementById('speedRange').value); 
            let pointsPerFrame = speed;
            if (speed > 6) pointsPerFrame = (speed - 4) * 5;

            function animate() {
                if (!isReplaying) return;

                if (forExport) {
                    drawCtx.drawImage(bgCanvas, 0, 0);
                    for(let i=0; i<actionIdx; i++) {
                        drawStroke(actions[i]);
                    }
                     const act = actions[actionIdx];
                     if (act) {
                         const partial = {...act, points: act.points.slice(0, pointIdx+1)};
                         drawStroke(partial);
                     }
                }

                if (!forExport) {
                     const act = actions[actionIdx];
                     if (pointIdx === 0) {
                        drawCtx.beginPath();
                        setupCtxStyle(act);
                        if(act.points.length > 0) drawCtx.moveTo(act.points[0].x, act.points[0].y);
                        pointIdx = 1;
                     }
                     for(let k=0; k < pointsPerFrame; k++) {
                        if (pointIdx < act.points.length) {
                            drawCtx.lineTo(act.points[pointIdx].x, act.points[pointIdx].y);
                            drawCtx.stroke();
                            pointIdx++;
                        } else {
                            actionIdx++;
                            pointIdx = 0;
                            break;
                        }
                    }
                } else {
                    const act = actions[actionIdx];
                    pointIdx += pointsPerFrame;
                    if (pointIdx >= act.points.length) {
                        actionIdx++;
                        pointIdx = 0;
                    }
                }

                if (actionIdx >= actions.length) {
                    isReplaying = false;
                    toggleButtons(true);
                    if (forExport && recorder) {
                        recorder.stop();
                    } 
                } else {
                    requestAnimationFrame(animate);
                }
            }
            animate();
        }

        function setupCtxStyle(act) {
            drawCtx.lineCap = 'round'; drawCtx.lineJoin = 'round';
            if (act.tool === 'eraser') {
                drawCtx.globalCompositeOperation = 'destination-out';
                drawCtx.lineWidth = 60;
            } else {
                drawCtx.globalCompositeOperation = 'source-over';
                drawCtx.strokeStyle = act.color;
                drawCtx.lineWidth = act.width;
            }
        }

        function drawStroke(act) {
            drawCtx.beginPath();
            setupCtxStyle(act);
            if(act.points.length > 0) {
                drawCtx.moveTo(act.points[0].x, act.points[0].y);
                for (let i = 1; i < act.points.length; i++) {
                    drawCtx.lineTo(act.points[i].x, act.points[i].y);
                }
                drawCtx.stroke();
            }
        }

        function redrawAll() {
            drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
            actions.forEach(act => drawStroke(act));
        }

        function toggleButtons(enable) {
            document.getElementById('btnPlay').disabled = !enable;
            document.getElementById('btnExport').disabled = !enable;
        }

        function downloadImage() {
            const temp = document.createElement('canvas');
            temp.width = bgCanvas.width;
            temp.height = bgCanvas.height;
            const tCtx = temp.getContext('2d');
            tCtx.drawImage(bgCanvas, 0, 0);
            tCtx.drawImage(drawCanvas, 0, 0);
            const link = document.createElement('a');
            link.download = 'propisi_page.jpg';
            link.href = temp.toDataURL('image/jpeg', 0.9);
            link.click();
        }
    </script>
</body>
</html>
